#!/bin/bash sh

#
# Filename:         vfiolib-usage
# Description:      Usage
# Author(s):        Alex Portell <github.com/portellam>
# Maintainer(s):    Alex Portell <github.com/portellam>
#

# <remarks> Using </remarks>
# <code>
    source bashlib-all
# </code>

# <code>
    function GetOption
    {
        while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do case $1 in
            # <remarks> Options </remarks>
            "-c" | "--cpu" )
                bool_alloc_cpu=true
                ;;

            "-e" | "--evdev" )
                bool_evdev=true
                ;;

            "-f" | "--file" )
                bool_parse_IOMMU_from_file=true
                GetSelect_IOMMU_Args $2
                ;;

            "--help" )
                return 1
                ;;

            "-h" | "--hugepages" )
                bool_hugepages=true
                GetHugepageByteSize $2 || GetHugepageCount $2
                GetHugepageByteSize $3 || GetHugepageCount $3
                ;;

            "-H" | "--hooks" )
                bool_libvirt_hooks=true
                ;;

            "-i" | "--internal" )
                bool_parse_IOMMU_from_local=true
                GetSelect_IOMMU_Args $2
                ;;

            "-I" | "--internet" )
                bool_parse_IOMMU_from_internet=true
                GetSelect_IOMMU_Args $2
                ;;

            "-l" | "--looking-glass" )
                bool_looking_glass=true
                ;;

            "-L" | "--loopback" )
                bool_audio_loopback=true
                ;;

            "-m" | "--multiboot" )
                bool_multiboot=true
                ;;

            "-s" | "--static" )
                bool_static=true
                ;;

            "-S" | "--scream" )
                bool_scream=true
                ;;

            "-S" | "--uninstall" )
                bool_uninstall=true
                ;;

            "-z" | "--zram-swap" )
                bool_zram_swap=true
                ;;

            # <remarks> Else </remarks>
            "" )
                ;;

            * )
                echo -e "${var_prefix_warn} Invalid input."
                return 1
                ;;
        esac; shift; done

        if [[ "$1" == '--' ]]; then shift; fi
        return 0
    }

    function GetHugepageByteSize
    {
        if IsString $1 &> /dev/null && ( [[ $1 == "2M" ]] || [[ $1 == "1G" ]] ); then
            bool_hugepage_set_size=true
            declare -g str_huge_page_byte_prefix=$1
            return 0
        fi

        return 1
    }

    function GetHugepageCount
    {
        if IsNum $1 &> /dev/null && [[ $1 -gt 0 ]]; then
            bool_hugepage_set_count=true
            declare -g int_huge_page_count=$1
        fi

        return 1
    }

    function GetSelect_IOMMU_Args
    {
        case $1 in
            "all" )
                bool_select_all_IOMMU=true
                ;;

            * )
                ;;
        esac

        return 0
    }

    function GetUsage
    {
        IFS=$'\n'

        declare -ar arr_output=(
            "Usage:\tbash vfiolib-all [OPTION]... [ARGS]..."
            "Deploy a PCI Passthrough (VFIO) setup."
            "\t--help\t\t\tPrint this usage statement"
            "\nParse PCI:"
            "\t-f, --file\t\tReference file database"
            "\t-i, --internal\t\tReference local database"
            "\t-I, --internet\t\tReference online database"
            "\t\tall\t\tSelect all IOMMU groups (useful for Multiboot VFIO)"
            "\nSetup:"
            "\t-m, --multiboot\t\tCreate multiple GRUB entries for a Multi VGA VFIO setup"
            "\t-s, --static\t\tInstall a Single VGA VFIO setup"
            "\t-u, --uninstall\t\tUndo an existing VFIO setup"
            "\nExtras:"
            "\t-c, --cpu\t\tAllocate CPU"
            "\t-e, --evdev\t\tSetup a virtual KVM switch"
            "\t-h, --hugepages\t\tAllocate RAM"
            "\t-h\t2M, 1G [Amount]\tHugepage [size]"
            "\t-h\t[size] [1-?]\t[Amount] of Hugepages"
            ""
            "\t-H, --hooks\t\tInstall recommended libvirt-hooks and services"
            "\t-l, --looking-glass\tInstall LookingGlass"
            "\t-L, --audio-loopback\tInstall the audio loopback service"
            "\t-S, --scream\t\tInstall Scream"
            "\t-z, --zram-swap\t\tCreate swap in RAM"

            "\nExample:"
            "\tbash vfiolib-all -m \t\tParse PCI locally, then deploy a Multiboot VFIO setup."
            "\tbash vfiolib-all -s -i -p\tParse PCI from Internet, to re-deploy a Static VFIO setup, with hugepages."
        )

        echo -e "${arr_output[*]}"
        return 0
    }

    # <summary> Sets the options. Exit early (Pass) if input is null. Else, exit early (Fail) if input is invalid. </summary>
    # <param name="$@"> array: the input parameters </param>
    function SetOptions
    {
        for var_option in $@; do
            IsString $var_option &> /dev/null || return 0
            GetOption $var_option || return $?
        done

        return 0
    }
# </code>

# <params>
    # <remarks> Get script directories </remarks
    GetScriptDir
    declare -g str_files_dir="$( find .. -name files | uniq | head -n1 | cut -c2- )/"

    # <remarks> Toggles </remarks
    declare -g bool_is_connected_to_Internet=false

    # <remarks> Usage toggles </remarks
    declare -g bool_alloc_cpu=false
    declare -g bool_audio_loopback=false
    declare -g bool_evdev=false
    declare -g bool_hugepages=false
    declare -g bool_hugepage_set_count=false
    declare -g bool_hugepage_set_size=false
    declare -g bool_libvirt_hooks=false
    declare -g bool_looking_glass=false
    declare -g bool_multiboot=false
    declare -g bool_parse_IOMMU_from_file=false
    declare -g bool_parse_IOMMU_from_local=false
    declare -g bool_parse_IOMMU_from_internet=false
    declare -g bool_scream=false
    declare -g bool_select_all_IOMMU
    declare -g bool_static=false
    declare -g bool_uninstall=false
    declare -g bool_zram_swap=false
# </params>