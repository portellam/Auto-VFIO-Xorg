#!/bin/bash sh

#
# Filename:         vfiolib-setup
# Description:      Select VFIO setup.
# Author(s):        Alex Portell <github.com/portellam>
# Maintainer(s):    Alex Portell <github.com/portellam>
#

# <remarks> Using </remarks>
# <code>
    source vfiolib-common
    source vfiolib-extras
    source vfiolib-files
    source vfiolib-parse
    source vfiolib-usage
# </code>

# <code>
    function AreParamsNotEmptyForMultibootSetup
    {
        if ( [[ -z "$_VGA_VFIOPCI_DRIVER_DELIM"  ]] \
            || ( [[ -z "$_VGA_PCISTUB_HWID_DELIM" ]] \
            && [[ -z "$_VGA_VFIOPCI_HWID_DELIM" ]] )); then
            echo -e "$_PREFIX_ERROR Output is empty."
            return 1
        fi

        return 0
    }

    function AreParamsNotEmptyForStaticSetup
    {
        if ( [[ -z "$_VFIOPCI_DRIVER_DELIM"  ]] \
            || ( [[ -z "$_PCISTUB_HWID_DELIM" ]] \
            && [[ -z "$_VFIOPCI_HWID_DELIM" ]] )); then
            echo -e "$_PREFIX_ERROR Output is empty."
            return 1
        fi

        return 0
    }

    function AskToSpecify_GRUB_MenuEntryForMultibootSetup
    {
        if "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_DEFAULT" \
            || "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_FIRST" \
            || "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_LAST" \
            || "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_VALUE"; then
            return 0
        fi

        local -ar _INDEX_LIST=( "${!_MENU_ENTRY_TITLE_LIST[@]}" )
        local -i _LAST_INDEX="${_INDEX_LIST[-1]}"

        for _TRIES_COUNT in $( seq 0 2 ); do
            echo -e "\nList of valid GRUB menu entries:"
            PrintListOf_GRUB_MenuEntry
            echo
            read -r -p "Enter preferred GRUB menu entry [0-$_LAST_INDEX]: " _ANSWER

            if [[ -z "$_ANSWER" ]] \
                || [[ "$_ANSWER" -eq 0 ]]; then
                _EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_DEFAULT=true
                return 0
            fi

            if [[ "$_ANSWER" -gt 0 ]] \
                && [[ "$_ANSWER" -le "$_LAST_INDEX" ]]; then
                _EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_DEFAULT=false
                _PREFERRED_MENU_ENTRY_TITLE="${_MENU_ENTRY_TITLE_LIST[$_ANSWER]}"
                return 0
            fi

            echo -e "Please answer between 0 and $_LAST_INDEX."
        done

        echo -e "$_PREFIX_ERROR Failed to answer."
        return 1
    }

    function AskToSpecifyStaticSetup
    {
        if ! "$_ASK_TO_EXECUTE_VFIO_SETUP_STATIC"; then
            return 0
        fi

        for _TRIES_COUNT in $( seq 0 2 ); do
            read -r -p "Write output to GRUB only? [Y/n]: " _ANSWER

            case "$_ANSWER" in
                [Yy]* )
                    _EXECUTE_VFIO_SETUP_STATIC_WITH_GRUB=true
                    return 0 ;;

                [Nn]* )
                    _EXECUTE_VFIO_SETUP_STATIC_WITH_GRUB=false
                    return 0 ;;

                * )
                    echo "Please answer 'Y' or 'N'." ;;
            esac
        done

        echo -e "$_PREFIX_ERROR Failed to answer."
        return 1
    }

    function ExecuteMultibootSetup
    {
        if ! "$_HAS_EXECUTED_BACKUPS" \
            || ! GetAllParamsForMultibootSetup \
            || ! WriteFilesForMultibootSetup \
            || ! ExecuteUpdateAfterSetup; then
            return 1
        fi

        return 0
    }

    function ExecuteStaticSetup
    {
        DoesHostHave_VGA || return 1
        AskToSpecifyStaticSetup || return 1

        if "$_EXECUTE_VFIO_SETUP_STATIC_WITH_GRUB" \
            && ( ! "$_HAS_EXECUTED_BACKUPS" \
            || ! GetParamsForAnySetup \
            || ! AreParamsNotEmptyForStaticSetup \
            || ! WriteFilesFor_GRUB_StaticSetup \
            || ! ExecuteUpdateAfterSetup ); then
            return 1
        fi

        if ! "$_EXECUTE_VFIO_SETUP_STATIC_WITH_GRUB" \
            && ( ! "$_HAS_EXECUTED_BACKUPS" \
            || ! GetParamsForAnySetup \
            || ! AreParamsNotEmptyForStaticSetup \
            || ! GetListsForNo_GRUB_StaticSetup \
            || ! WriteFilesForNo_GRUB_StaticSetup \
            || ! ExecuteUpdateAfterSetup ); then
            return 1
        fi

        return 0
    }

    function ExecuteUninstallSetup
    {
        if ! "$_HAS_EXECUTED_BACKUPS" \
            || ! ExecuteUpdateAfterSetup; then
            echo -e "$_PREFIX_ERROR Uninstall has failed."
        fi

        return 0
    }

    function ExecuteUpdateAfterSetup
    {
        Update_GRUB || return 1
        UpdateInitramfs || return 1
        return 0
    }

    function ExecuteSetup
    {
        function Main
        {
            if "$_ASK_TO_EXECUTE_VFIO_SETUP"; then
                echo
            fi

            while [[ "$?" -ne 1 ]]; do
                if "$_ASK_TO_EXECUTE_VFIO_SETUP"; then
                    for _TRIES_COUNT in $( seq 0 2 ); do
                        read -r -p "Execute VFIO setup? [(M)ultiboot/(S)tatic/(U)ninstall/(N)o]: " _ANSWER

                        case "$_ANSWER" in
                            [Mm]* )
                                _EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB=true
                                break ;;

                            [Ss]* )
                                _EXECUTE_VFIO_SETUP_STATIC_WITHOUT_GRUB=true
                                break ;;

                            [Uu]* )
                                _EXECUTE_VFIO_SETUP_UNINSTALL=true
                                break ;;

                            [Nn]* )
                                return 255 ;;

                            * )
                                echo "Please answer 'M', 'S', 'U', or 'N'." ;;
                        esac
                    done

                    if ! [[ "$_ANSWER" =~ [MmSsUuNn] ]]; then
                        echo -e "$_PREFIX_ERROR Failed to answer."
                        return 1
                    fi
                fi

                case true in
                    "$_EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB" )
                        ExecuteParse || return 1
                        ExecuteMultibootSetup || return 1 ;;

                    "$_EXECUTE_VFIO_SETUP_STATIC_WITHOUT_GRUB" )
                        ExecuteParse || return 1
                        ExecuteStaticSetup || return 1 ;;

                    "$_EXECUTE_VFIO_SETUP_UNINSTALL" )
                        ExecuteUninstallSetup || return 1 ;;
                esac

                break
            done

            return "$?"
        }

        local _OUTPUT="Executing VFIO setup...\t"
        PrintSuffixWait "$_OUTPUT"
        Main
        PrintSuffixPassOrFail "$_OUTPUT"
        return "$_LAST_EXIT_CODE"
    }

    function GetAllParamsForMultibootSetup
    {
        IFS=$'\n'
        _IOMMU_GROUP_ID_LIST_WITH_VGA_FOR_VFIO=( $( sort -r <<<"${_IOMMU_GROUP_ID_LIST_WITH_VGA_FOR_VFIO[*]}" ) )
        unset IFS

        # <remarks> System configuration </remarks>
        local -i _MAX_NUM_PARSE_KERNELS=3
        declare -a _KERNELS_LIST=( $( ls -1 /boot/vmli* | cut -d 'z' -f 2 | cut -c 2- | sort -r | head -n $_MAX_NUM_PARSE_KERNELS ) )
        local _SYSTEM_DISK=$( df / | grep -iv 'filesystem' | cut -d '/' -f3 | cut -d ' ' -f1 )
        local _SYSTEM_DISTRO=$( lsb_release -i -s )
        local _SYSTEM_FSTYPE=$( blkid -s TYPE | grep $_SYSTEM_DISK | cut -d '"' -f2 )
        local _SYSTEM_KERNEL=$( uname -o )
        local _SYSTEM_OS=$( uname )
        local _SYSTEM_UUID=$( blkid -s UUID | grep $_SYSTEM_DISK | cut -d '"' -f2 )
        local _LINE_GRUB_CMDLINE_PREFIX=""
        _LINE_GRUB_CMDLINE_PREFIX+="$_LINE_GRUB_CMDLINE "

        if [[ ! -z "$_LINE_GRUB_CMDLINE_ISOLCPU" ]]; then
            _LINE_GRUB_CMDLINE_PREFIX+="$_LINE_GRUB_CMDLINE_ISOLCPU "
        fi

        if [[ ! -z "$_OUTPUT_GRUB_CMDLINE_HUGEPAGES" ]]; then
            _LINE_GRUB_CMDLINE_PREFIX+="$_OUTPUT_GRUB_CMDLINE_HUGEPAGES "
        fi

        GetParamsForAnySetup || return 1

        for _THIS_IOMMU_GROUP_ID in ${_IOMMU_GROUP_ID_LIST_WITH_VGA_FOR_VFIO[@]}; do
            declare -g _THIS_IOMMU_GROUP_VGA_NAME=""
            GetNameFor_IOMMU_GroupWith_VGA "$_THIS_IOMMU_GROUP_ID"

            for _IOMMU_GROUP_ID in ${_IOMMU_GROUP_ID_LIST_WITH_VGA_FOR_VFIO[@]}; do
                if [[ "$_IOMMU_GROUP_ID" != "$_THIS_IOMMU_GROUP_ID" ]]; then
                    # <remarks> Clear values before this next pass. </remarks>
		            _THIS_DRIVER_DELIM=""
                    _THIS_PCISTUB_HWID_DELIM=""
                    _THIS_VFIOPCI_HWID_DELIM=""
		            _VGA_VFIOPCI_DRIVER_DELIM=""
                    _VGA_VFIOPCI_HWID_DELIM=""

                    GetParamsForMultibootSetup "$_IOMMU_GROUP_ID" || return 1
                    GetListsForMultibootSetup "$_IOMMU_GROUP_ID"
                fi
            done
        done

        if [[ "${#_FILE_CONTENTS_LIST[@]}" -eq 0 ]]; then
            echo -e "$_PREFIX_ERROR Multiboot setup output is empty."
            return 1
        fi

        return 0
    }

    function GetListsFor_IOMMU_Group
    {
        local -a _CLASS_LIST="${_CLASS_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"
        local -a _DRIVER_LIST="${_DRIVER_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"
        local -a _HWID_LIST="${_HWID_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"

        for _KEY in ${!_HWID_LIST[@]}; do
            local _CLASS=${_CLASS_LIST[$_KEY]}
            local _DRIVER=${_DRIVER_LIST[$_KEY]}
            local _HWID=${_HWID_LIST[$_KEY]}

            if [[ ! -z "$_HWID" ]] \
                && IsDeviceFor_PCISTUB "$_CLASS"; then
                _PCISTUB_HWID_DELIM+="$_HWID,"
            fi

            if [[ ! -z "$_HWID" ]] \
                && ! IsDeviceFor_PCISTUB "$_CLASS"; then
                _VFIOPCI_HWID_DELIM+="$_HWID,"
            fi

            if IsDriverNotOnIgnoreList "$_DRIVER"; then
                _VFIOPCI_DRIVER_DELIM+="$_DRIVER,"
                _VFIOPCI_DRIVER_LIST+=( "$_DRIVER" )
            fi
        done

        return 0
    }

    function GetListsFor_IOMMU_GroupWith_By_PCI_ID
    {
        local -a _PCI_ID_LIST="${_PCI_ID_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"

        for _KEY in ${!_PCI_ID_LIST[@]}; do
            local _PCI_ID_DELIM=${_PCI_ID_LIST[$_KEY]}
            local -i _DELIM_COUNT=1
            local _PCI_ID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_PCI_ID_DELIM" )

            while [[ ! -z "$_PCI_ID" ]]; do
                local _PCI_ID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_PCI_ID_DELIM" )
                local _CLASS="$( lspci -ms $_PCI_ID | cut -d '"' -f 2 )"
                local _DRIVER=$( lspci -ks $_PCI_ID | grep -i "driver" | cut -d " " -f 5 )
                local _HWID=$( lspci -ns $_PCI_ID | cut -d " " -f 3 )

                if [[ ! -z "$_HWID" ]] \
                    && IsDeviceFor_PCISTUB "$_CLASS"; then
                    _PCISTUB_HWID_DELIM+="$_HWID,"
                fi

                if [[ ! -z "$_HWID" ]] \
                    && ! IsDeviceFor_PCISTUB "$_CLASS"; then
                    _VFIOPCI_HWID_DELIM+="$_HWID,"
                fi

                if IsDriverNotOnIgnoreList "$_DRIVER"; then
                    _VFIOPCI_DRIVER_DELIM+="$_DRIVER,"
                    _VFIOPCI_DRIVER_LIST+=( "$_DRIVER" )
                fi

                (( _DELIM_COUNT++ ))
            done
        done

        return 0
    }

    function GetListsFor_IOMMU_GroupWith_VGA
    {
        local -a _CLASS_LIST="${_CLASS_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"
        local -a _DRIVER_LIST="${_DRIVER_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"
        local -a _HWID_LIST="${_HWID_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"

        for _KEY in ${!_HWID_LIST[@]}; do
            local _CLASS_DELIM=${_CLASS_LIST[$_KEY]}
            local _DRIVER_DELIM=${_DRIVER_LIST[$_KEY]}
            local _HWID_DELIM=${_HWID_LIST[$_KEY]}
            local _NAME_DELIM=${_NAME_LIST[$_KEY]}
            local -i _DELIM_COUNT=1
            local _HWID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_HWID_DELIM" )

            while [[ ! -z "$_HWID" ]]; do
                local _CLASS=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_CLASS_DELIM" )
                local _DRIVER=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_DRIVER_DELIM" )
                _HWID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_HWID_DELIM" )
                local _NAME=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_NAME_DELIM" )

                if [[ ! -z "$_HWID" ]] \
                    && IsDeviceFor_PCISTUB "$_CLASS"; then
                    _VGA_PCISTUB_HWID_DELIM+="$_HWID,"
                fi

                if [[ ! -z "$_HWID" ]] \
                    && ! IsDeviceFor_PCISTUB "$_CLASS"; then
                    _VGA_VFIOPCI_HWID_DELIM+="$_HWID,"
                fi

                if [[ ! -z "$_DRIVER" ]] \
                    && IsDriverNotOnIgnoreList "$_DRIVER"; then
                    _VGA_VFIOPCI_DRIVER_DELIM+="$_DRIVER,"
                fi

                if ! "$_EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB" \
                    && [[ ! -z "$_DRIVER" ]] \
                    && IsDriverNotOnIgnoreList "$_DRIVER"; then
                    _VGA_VFIOPCI_DRIVER_LIST+=( "$_DRIVER" )
                fi

                (( _DELIM_COUNT++ ))
            done
        done

        return 0
    }

    function GetListsFor_IOMMU_GroupWith_VGA_By_PCI_ID
    {
        local -a _PCI_ID_LIST="${_PCI_ID_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"

        for _KEY in ${!_PCI_ID_LIST[@]}; do
            local _PCI_ID_DELIM=${_PCI_ID_LIST[$_KEY]}
            local -i _DELIM_COUNT=1
            local _PCI_ID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_PCI_ID_DELIM" )

            while [[ ! -z "$_PCI_ID" ]]; do
                local _PCI_ID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_PCI_ID_DELIM" )
                local _CLASS="$( lspci -ms $_PCI_ID | cut -d '"' -f 2 )"
                local _DRIVER=$( lspci -ks $_PCI_ID | grep -i "driver" | cut -d " " -f 5 )
                local _HWID=$( lspci -ns $_PCI_ID | cut -d " " -f 3 )
                local _NAME="$( lspci -ms $_PCI_ID | cut -d '"' -f 6 )"

                if [[ ! -z "$_HWID" ]] \
                    && IsDeviceFor_PCISTUB "$_CLASS"; then
                    _VGA_PCISTUB_HWID_DELIM+="$_HWID,"
                fi

                if [[ ! -z "$_HWID" ]] \
                    && ! IsDeviceFor_PCISTUB "$_CLASS"; then
                    _VGA_VFIOPCI_HWID_DELIM+="$_HWID,"
                fi

                if [[ ! -z "$_DRIVER" ]] \
                    && IsDriverNotOnIgnoreList "$_DRIVER"; then
                    _VGA_VFIOPCI_DRIVER_DELIM+="$_DRIVER,"
                fi

                if ! "$_EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB" \
                    && [[ ! -z "$_DRIVER" ]] \
                    && IsDriverNotOnIgnoreList "$_DRIVER"; then
                    _VGA_VFIOPCI_DRIVER_LIST+=( "$_DRIVER" )
                fi

                (( _DELIM_COUNT++ ))
            done
        done

        return 0
    }

    function GetNameFor_IOMMU_GroupWith_VGA
    {
        local -a _PCI_ID_LIST="${_PCI_ID_BY_VALID_IOMMU_GROUP_ID_LIST[$1]}"

        for _KEY in ${!_PCI_ID_LIST[@]}; do
            local _PCI_ID_DELIM=${_PCI_ID_LIST[$_KEY]}
            local -i _DELIM_COUNT=1
            local _PCI_ID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_PCI_ID_DELIM" )

            while [[ ! -z "$_PCI_ID" ]]; do
                local _PCI_ID=$( cut -d ' ' -f $_DELIM_COUNT <<< "$_PCI_ID_DELIM" )
                local _CLASS="$( lspci -ms $_PCI_ID | cut -d '"' -f 2 )"
                local _NAME="$( lspci -ms $_PCI_ID | cut -d '"' -f 6 )"

                if IsDevice_VGA "$_CLASS"; then
                    _THIS_IOMMU_GROUP_VGA_NAME="$_NAME"
                    return 0
                fi

                (( _DELIM_COUNT++ ))
            done
        done

        return 0
    }

    function GetListsForMultibootSetup
    {
        for _KERNEL in ${_KERNELS_LIST[@]}; do
            # <remarks> Organize menu entry for excluded VGA group and given system kernel. </remarks>
            local _MENU_ENTRY_TITLE="$_SYSTEM_DISTRO, with $_SYSTEM_OS $_KERNEL (VFIO, w/o IOMMU '$1' w/ '$_THIS_IOMMU_GROUP_VGA_NAME')"
            _MENU_ENTRY_TITLE_LIST+=( "$_MENU_ENTRY_TITLE" )
            GetPreferred_GRUB_MenuEntryForMultibootSetup "$1" "$_MENU_ENTRY_TITLE" || return 1

            _FILE_CONTENTS_LIST+=(
                "menuentry \"$_MENU_ENTRY_TITLE\"{"
                # "\tload_video"
                # "insmod gzio"
                # "if [ x\$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi"
                # "insmod part_gpt"
                "\tinsmod $_SYSTEM_FSTYPE"
                "\tset root='/dev/disk/by-uuid/$_SYSTEM_UUID'"
                "\t"'if [ x$feature_platform_search_hint = xy ]; then'"\n\t\t"'search --no-floppy --fs-uuid --set=root '"$_SYSTEM_UUID\n\t"'fi'
                "\techo    'Loading $_SYSTEM_OS $_KERNEL ...'"
                "\tlinux   /boot/vmlinuz-$_KERNEL root=UUID=$_SYSTEM_UUID $_LINE_GRUB_CMDLINE_TEMP"
                "\tinitrd  /boot/initrd.img-$_KERNEL"
                "\techo    \"VFIO, w/o IOMMU '$1' w/ '$_THIS_IOMMU_GROUP_VGA_NAME'\""
                "}"
                ""
            )
        done

        return 0
    }

    function GetListsForNo_GRUB_StaticSetup
    {
        declare -ag _BLACKLISTS_LIST=( )
        declare -ag _INITRAMFS_LIST=( )
        declare -ag _MODULES_LIST=( )
        declare -g _HWID_DELIM=""

        for _DRIVER in ${_VFIOPCI_DRIVER_LIST[@]}; do
            _BLACKLISTS_LIST+=(
                "blacklist $_DRIVER"
            )

            _INITRAMFS_LIST+=(
                "softdep $_DRIVER pre: vfio-pci"
                "$_DRIVER"
            )

            _MODULES_LIST+=(
                "softdep $_DRIVER pre: vfio-pci"
            )
        done

        if [[ ! -z "$_THIS_PCISTUB_HWID_DELIM" ]] \
            && [[ ! -z "$_THIS_VFIOPCI_HWID_DELIM" ]]; then
            _THIS_VFIOPCI_HWID_DELIM+=",$_THIS_PCISTUB_HWID_DELIM"
        fi

        if [[ ! -z "$_THIS_PCISTUB_HWID_DELIM" ]] \
            && [[ -z "$_THIS_VFIOPCI_HWID_DELIM" ]]; then
            _THIS_VFIOPCI_HWID_DELIM="$_THIS_PCISTUB_HWID_DELIM"
        fi

        return 0
    }

    function GetParamsForAnySetup
    {
        declare -g _THIS_DRIVER_DELIM=""
        declare -g _THIS_PCISTUB_HWID_DELIM=""
        declare -g _THIS_VFIOPCI_HWID_DELIM=""
        declare -g _PCISTUB_HWID_DELIM=""
        declare -g _VFIOPCI_DRIVER_DELIM=""
        declare -g _VFIOPCI_HWID_DELIM=""
        declare -g _VGA_PCISTUB_HWID_DELIM=""
        declare -g _VGA_VFIOPCI_DRIVER_DELIM=""
        declare -g _VGA_VFIOPCI_HWID_DELIM=""

        if ! "$_EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB"; then
            declare -ga _VFIOPCI_DRIVER_LIST=( )
            declare -ga _VGA_VFIOPCI_DRIVER_LIST=( )
        fi

        for _IOMMU_GROUP_ID in ${_IOMMU_GROUP_ID_LIST_FOR_VFIO[@]}; do
            GetListsFor_IOMMU_Group "$_IOMMU_GROUP_ID" || return 1
        done

        if ! "$_EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB"; then
            for _IOMMU_GROUP_ID in ${_IOMMU_GROUP_ID_LIST_WITH_VGA_FOR_VFIO[@]}; do
                GetListsFor_IOMMU_GroupWith_VGA "$_IOMMU_GROUP_ID" || return 1
            done
        fi

        if [[ ! -z "$_VFIOPCI_DRIVER_DELIM" ]]; then
            _VFIOPCI_DRIVER_DELIM="${_VFIOPCI_DRIVER_DELIM::-1}"
        fi

        if [[ ! -z "$_PCISTUB_HWID_DELIM" ]]; then
            _PCISTUB_HWID_DELIM="${_PCISTUB_HWID_DELIM::-1}"
        fi

        if [[ ! -z "$_VFIOPCI_HWID_DELIM" ]]; then
            _VFIOPCI_HWID_DELIM="${_VFIOPCI_HWID_DELIM::-1}"
        fi

        if ! "$_EXECUTE_VFIO_SETUP_MULTIBOOT_WITH_GRUB"; then
            GetTempListForAnySetup
            IFS=$'\n'
            _VFIOPCI_DRIVER_LIST+=( $( sort -u <<<"${_VGA_VFIOPCI_DRIVER_LIST[*]}" ) )
            _VFIOPCI_DRIVER_LIST=( $( sort -u <<<"${_VFIOPCI_DRIVER_LIST[*]}" ) )
            unset IFS
        fi

        return 0
    }

    function GetParamsForMultibootSetup
    {
        GetListsFor_IOMMU_GroupWith_VGA "$1" || return 1
        GetTempListForAnySetup
        declare -g _LINE_GRUB_CMDLINE_TEMP=""
        _LINE_GRUB_CMDLINE_TEMP+="modprobe.blacklist=$_THIS_DRIVER_DELIM "
        _LINE_GRUB_CMDLINE_TEMP+="pci_stub.ids=$_THIS_PCISTUB_HWID_DELIM "
        _LINE_GRUB_CMDLINE_TEMP+="vfio_pci.ids=$_THIS_VFIOPCI_HWID_DELIM "
        _LINE_GRUB_CMDLINE_TEMP="$_LINE_GRUB_CMDLINE_PREFIX${_LINE_GRUB_CMDLINE_TEMP::-1}"
        return 0
    }

    function GetPreferred_GRUB_MenuEntryForMultibootSetup
    {
        if "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_FIRST" \
            && [[ "$1" -eq 1 ]]; then
            _PREFERRED_MENU_ENTRY_TITLE="$2"
            return 0

        elif "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_VALUE" \
            && [[ "$1" -eq "$_MULTIBOOT_PREFERRED_IOMMU_GROUP_ID" ]]; then
            _PREFERRED_MENU_ENTRY_TITLE="$2"
            return 0

        elif "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_LAST" \
            && [[ "$1" -eq "${#_IOMMU_GROUP_ID_LIST_WITH_VGA_FOR_VFIO[-1]}" ]]; then
            _PREFERRED_MENU_ENTRY_TITLE="$2"
            return 0

        elif "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_DEFAULT"; then
            return 0

        else
            return 1
        fi
    }

    function GetTempListForAnySetup
    {
        if [[ ! -z "$_VFIOPCI_DRIVER_DELIM" ]]; then
            _THIS_DRIVER_DELIM+="$_VFIOPCI_DRIVER_DELIM,"
        fi

        if [[ ! -z "$_VGA_VFIOPCI_DRIVER_DELIM" ]]; then
            _THIS_DRIVER_DELIM+="$_VGA_VFIOPCI_DRIVER_DELIM,"
        fi

        if [[ ! -z "$_PCISTUB_HWID_DELIM" ]]; then
            _THIS_PCISTUB_HWID_DELIM+="$_PCISTUB_HWID_DELIM,"
        fi

        if [[ ! -z "$_VGA_PCISTUB_HWID_DELIM" ]]; then
            _VGA_PCISTUB_HWID_DELIM="${_VGA_PCISTUB_HWID_DELIM::-1}"
            _THIS_PCISTUB_HWID_DELIM+="$_VGA_PCISTUB_HWID_DELIM,"
        fi

        if [[ ! -z "$_VFIOPCI_HWID_DELIM" ]]; then
            _THIS_VFIOPCI_HWID_DELIM+="$_VFIOPCI_HWID_DELIM,"
        fi

        if [[ ! -z "$_VGA_VFIOPCI_HWID_DELIM" ]]; then
            _VGA_VFIOPCI_HWID_DELIM="${_VGA_VFIOPCI_HWID_DELIM::-1}"
            _THIS_VFIOPCI_HWID_DELIM+="$_VGA_VFIOPCI_HWID_DELIM,"
        fi

        if [[ "$_THIS_PCISTUB_HWID_DELIM" == *"," ]]; then
            _THIS_PCISTUB_HWID_DELIM="${_THIS_PCISTUB_HWID_DELIM::-1}"
        fi

        if [[ "$_THIS_VFIOPCI_HWID_DELIM" == *"," ]]; then
            _THIS_VFIOPCI_HWID_DELIM="${_THIS_VFIOPCI_HWID_DELIM::-1}"
        fi

        if [[ "$_THIS_DRIVER_DELIM" == *"," ]]; then
            _THIS_DRIVER_DELIM="${_THIS_DRIVER_DELIM::-1}"
        fi

        if [[ "$_THIS_PCISTUB_HWID_DELIM" == *"," ]]; then
            _THIS_PCISTUB_HWID_DELIM="${_THIS_PCISTUB_HWID_DELIM::-1}"
        fi

        if [[ "$_THIS_VFIOPCI_HWID_DELIM" == *"," ]]; then
            _THIS_VFIOPCI_HWID_DELIM="${_THIS_VFIOPCI_HWID_DELIM::-1}"
        fi

        if [[ "$_THIS_DRIVER_DELIM" == *"," ]]; then
            _THIS_DRIVER_DELIM="${_THIS_DRIVER_DELIM::-1}"
        fi

        return 0
    }

    function PrintListOf_GRUB_MenuEntry
    {
        for _KEY in "${!_MENU_ENTRY_TITLE_LIST[@]}"; do
            echo -en "$_KEY:\t"

            if [[ "$_KEY" -gt 0 ]]; then
                echo -e "\"${_MENU_ENTRY_TITLE_LIST[$_KEY]}\""
            else
                echo -e "Default (no VFIO setup)"
            fi
        done

        return 0
    }

    function Update_GRUB
    {
        local _OUTPUT="Updating GRUB...\t"
        PrintSuffixWait "$_OUTPUT"
        sudo update-grub &> /dev/null
        PrintSuffixPassOrFail "$_OUTPUT"
        return "$?"
    }

    function UpdateInitramfs
    {
        local _OUTPUT="Updating Initramfs...\t"
        PrintSuffixWait "$_OUTPUT"
        sudo update-initramfs -u -k all &> /dev/null
        PrintSuffixPassOrFail "$_OUTPUT"
        return "$?"
    }

    function WriteFilesFor_GRUB_StaticSetup
    {
        "$_HAS_EXECUTED_BACKUPS" || return 1
        IFS=$'\n'
        local -r _LINE_TO_MATCH="GRUB_CMDLINE_LINUX_DEFAULT="
        local _LINE_GRUB_CMDLINE_TEMP=""
        _LINE_GRUB_CMDLINE_TEMP+="$_LINE_GRUB_CMDLINE "

        if [[ ! -z "$_LINE_GRUB_CMDLINE_ISOLCPU" ]]; then
            _LINE_GRUB_CMDLINE_PREFIX+="$_LINE_GRUB_CMDLINE_ISOLCPU "
        fi

        if [[ ! -z "$_OUTPUT_GRUB_CMDLINE_HUGEPAGES" ]]; then
            _LINE_GRUB_CMDLINE_PREFIX+="$_OUTPUT_GRUB_CMDLINE_HUGEPAGES "
        fi

        _LINE_GRUB_CMDLINE_TEMP+="modprobe.blacklist=$_THIS_DRIVER_DELIM "
        _LINE_GRUB_CMDLINE_TEMP+="pci_stub.ids=$_THIS_PCISTUB_HWID_DELIM "
        _LINE_GRUB_CMDLINE_TEMP+="vfio_pci.ids=$_THIS_VFIOPCI_HWID_DELIM "
        _LINE_GRUB_CMDLINE_TEMP="${_LINE_GRUB_CMDLINE_TEMP::-1}"
        local -r _LINE_GRUB_CMDLINE_DEFAULT="$_LINE_TO_MATCH\"$_LINE_GRUB_CMDLINE_TEMP\""

        if ! sed -i '/'"$_LINE_TO_MATCH"'/c\'"$_LINE_GRUB_CMDLINE_DEFAULT" "$_GRUB_DEST_PATH_1" &> /dev/null; then
            echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
            return 1
        fi

        unset IFS
        return 0
    }

    function WriteFilesForNo_GRUB_StaticSetup
    {
        "$_HAS_EXECUTED_BACKUPS" || return 1
        IFS=$'\n'
        local -r _LINE_TO_MATCH="GRUB_CMDLINE_LINUX_DEFAULT="
        local _LINE_GRUB_CMDLINE_TEMP=""
        _LINE_GRUB_CMDLINE_TEMP+="$_LINE_GRUB_CMDLINE "

        if [[ ! -z "$_LINE_GRUB_CMDLINE_ISOLCPU" ]]; then
            _LINE_GRUB_CMDLINE_PREFIX+="$_LINE_GRUB_CMDLINE_ISOLCPU "
        fi

        if [[ ! -z "$_OUTPUT_GRUB_CMDLINE_HUGEPAGES" ]]; then
            _LINE_GRUB_CMDLINE_PREFIX+="$_OUTPUT_GRUB_CMDLINE_HUGEPAGES "
        fi

        _LINE_GRUB_CMDLINE_TEMP="${_LINE_GRUB_CMDLINE_TEMP::-1}"
        local -r _LINE_GRUB_CMDLINE_DEFAULT="GRUB_CMDLINE_LINUX_DEFAULT=\"$_LINE_GRUB_CMDLINE_TEMP\""

        # <remarks> Write to new file. </remarks>
        local -i _KEY=$(( "${#_INITRAMFS_LIST[@]}" - 1 ))
        local -i _NUM_LINE=23

        while [[ "$_KEY" -ge 0 ]]; do
            _LINE="${_INITRAMFS_LIST[$_KEY]}"

            if ! sed -i "23i $_LINE" "$_INITRAMFS_MODULES_DEST_PATH"; then
                echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
                return 1
            fi

            (( --_KEY ))
        done

        if [[ "$?" -ne 0 ]]; then
            echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
            return 1
        fi

        # <remarks> Write to new file. </remarks>
        local -i _KEY=$(( "${#_MODULES_LIST[@]}" - 1 ))
        local -i _NUM_LINE=7

        while [[ "$_KEY" -ge 0 ]]; do
            _LINE="${_MODULES_LIST[$_KEY]}"

            if ! sed -i "7i $_LINE" "$_MODPROBE_VFIO_DEST_PATH"; then
                echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
                return 1
            fi

            (( --_KEY ))
        done

        if [[ "$?" -ne 0 ]]; then
            echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
            return 1
        fi

        # <remarks> Write to new files. </remarks>
        if ! sed -i '/'$_LINE_TO_MATCH'/c\'"$_LINE_GRUB_CMDLINE_DEFAULT" "$_GRUB_DEST_PATH_1" &> /dev/null \
            || ! sed -i "/# options vfio_pci ids=*/c\options vfio_pci_ids=\"$_THIS_VFIOPCI_HWID_DELIM\"" "$_INITRAMFS_MODULES_DEST_PATH" &> /dev/null \
            || ! sed -i "/# vfio_pci ids=*/c\vfio_pci_ids=\"$_THIS_VFIOPCI_HWID_DELIM\"" "$_INITRAMFS_MODULES_DEST_PATH" &> /dev/null \
            || ! echo -e "\n${_BLACKLISTS_LIST[*]}" >> "$_MODPROBE_BLACKLISTS_DEST_PATH" &> /dev/null \
            || ! sed -i "/# options vfio_pci ids=*/c\options vfio_pci ids=\"$_THIS_VFIOPCI_HWID_DELIM\"" "$_MODPROBE_VFIO_DEST_PATH" &> /dev/null \
            || ! sed -i "/# vfio_pci ids=*/c\vfio_pci_ids=\"$_THIS_VFIOPCI_HWID_DELIM\"" "$_MODULES_DEST_PATH" &> /dev/null; then
            echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
            return 1
        fi

        unset IFS
        return 0
    }

    function WriteFilesForMultibootSetup
    {
        "$_HAS_EXECUTED_BACKUPS" || return 1
        AskToSpecify_GRUB_MenuEntryForMultibootSetup || return 1
        IFS=$'\n'
        local -r _LINE_TO_MATCH="GRUB_DEFAULT="

        if "$_EXECUTE_VFIO_SETUP_MULTIBOOT_PREFER_DEFAULT"; then
            local -r _LINE_GRUB_DEFAULT="$_LINE_TO_MATCH$_DEFAULT_MENU_ENTRY_TITLE"
        else
            local -r _LINE_GRUB_DEFAULT="$_LINE_TO_MATCH\"$_PREFERRED_MENU_ENTRY_TITLE\""
        fi

        if [[ -d $( dirname "$_CUSTOM_GRUB_DEST_PATH" ) ]] \
            && ! sudo mkdir -p $( dirname "$_CUSTOM_GRUB_DEST_PATH" ); then
            echo -e "$_PREFIX_ERROR Failed to create directory '"$( dirname "$_CUSTOM_GRUB_DEST_PATH" )"'."
            return 1
        fi

        if ! sed -i '/'"$_LINE_TO_MATCH"'/c\'"$_LINE_GRUB_DEFAULT" "$_GRUB_DEST_PATH_1" \
            || ! echo -e "\n${_FILE_CONTENTS_LIST[*]}" >> "$_CUSTOM_GRUB_DEST_PATH" ; then
            echo -e "$_PREFIX_ERROR Failed to overwrite target lines of files."
            return 1
        fi

        unset IFS
        return 0
    }
# </code>

# <params>
    declare -g _DEFAULT_MENU_ENTRY_TITLE="0"
    declare -g _PREFERRED_MENU_ENTRY_TITLE=""
    declare -ga _MENU_ENTRY_TITLE_LIST=( "$_PREFERRED_MENU_ENTRY_TITLE" )

    # <remarks> Flags </remarks>
    _FLAG_ADD_EARLY_LOAD_MODULE_ARGS=true
    _FLAG_ADD_LOG_LEVEL_ARGS=true
    _FLAG_ADD_SET_POWER_ARGS=true
    _FLAG_ADD_SET_VIDEO_ARGS=true
    _FLAG_ADD_WIN10_REQUIRED_ARGS=true
    _FLAG_ADD_PRIVACY_ARGS=false

    declare -g _LINE_GRUB_CMDLINE="quiet splash amd_iommu=on intel_iommu=on iommu=1,pt"

    if "$_FLAG_ADD_LOG_LEVEL_ARGS"; then
        _LINE_GRUB_CMDLINE="loglevel=3 $_LINE_GRUB_CMDLINE"
    fi

    if "$_FLAG_ADD_PRIVACY_ARGS" \
        && IsInstalled "rfkill" &> /dev/null; then
        _LINE_GRUB_CMDLINE+=" rfkill.default_state=1 systemd.restore_state=0"
    fi

    if "$_FLAG_ADD_SET_POWER_ARGS"; then
        _LINE_GRUB_CMDLINE+=" acpi=force apm=power_off pcie_aspm=off"
    fi

    if "$_FLAG_ADD_EARLY_LOAD_MODULE_ARGS"; then
        _LINE_GRUB_CMDLINE+=" rd.driver.pre=vfio-pci rd.modules-load=vfio-pci"
    fi

    if "$_FLAG_ADD_SET_VIDEO_ARGS"; then
        _LINE_GRUB_CMDLINE+=" video=efifb:off,vesafb:off"
    fi

    if "$_FLAG_ADD_WIN10_REQUIRED_ARGS"; then
        _LINE_GRUB_CMDLINE+=" kvm.ignore_msrs=1"
    fi
# </params>
