#!/bin/bash/env bash

#
# Filename:         deploy-vfio
# Description:      Main executable.
# Author(s):        Alex Portell <github.com/portellam>
# Maintainer(s):    Alex Portell <github.com/portellam>
#

# <sources>
    source vfiolib-all
# </sources>

# <params>
    # <remarks> Feature Flags </remarks>
    declare -g _FLAG_DO_EXECUTE_BACKUPS=true
    declare -g _FLAG_DO_EXECUTE_PRE_SETUP=true
    declare -g _FLAG_DO_EXECUTE_POST_SETUP=true
    declare -g _FLAG_DO_SYSTEM_CHECK=true
# </params>

# <functions>
    function Main
    {
        IsSudoUser || return 1

        # <remarks> Gather arguments. </remarks>
        if ! GetOption "${@}"; then
            GetHelp
            return "${?}"
        fi

        if "${_FLAG_DO_SYSTEM_CHECK}" \
            && ! GetLinuxDistro \
            && ! IsSystemSupported; then
            return 1
        fi

        if "${_FLAG_DO_EXECUTE_BACKUPS}" \
            && ! ExecuteBackups; then
            exit "${?}"
        fi

        # <remarks> Exit early. </remarks>
        if "${_EXECUTE_VFIO_SETUP_UNINSTALL}"; then
            ExecuteMainSetup
            return "${?}"
        fi

        if "${_FLAG_DO_EXECUTE_PRE_SETUP}" \
            && ! ExecutePreSetup; then
            return 1
        fi

        if ( GetPassExitCode \
                || GetSkipExitCode ); then
            ExecuteMainSetup

            if ! GetPassExitCode \
                && ! GetSkipExitCode; then
                return 1
            fi
        fi

        if "${_FLAG_DO_EXECUTE_POST_SETUP}" \
            && ( GetPassExitCode \
                || GetSkipExitCode ) \
            && ! ExecutePostSetup; then
            return 1
        fi

        return "${?}"
    }
# </functions>

# <main>
    if "${_FLAG_DO_EXECUTE_BACKUPS}"; then
        BackupFiles || exit 1
    fi

    Main "${@}"

    if "${_FLAG_DO_EXECUTE_BACKUPS}" \
        && GetPassExitCode; then
        RestoreFiles || exit 1
    fi

    exit "${?}"
# </main>
