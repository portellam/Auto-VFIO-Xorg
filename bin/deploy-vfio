#!/bin/bash/env bash

#
# Filename:         deploy-vfio
# Description:      Main executable.
# Author(s):        Alex Portell <github.com/portellam>
# Maintainer(s):    Alex Portell <github.com/portellam>
#

# <sources>
    source vfiolib-all
# </sources>

# <params>
    # <remarks> Feature Flags </remarks>
    declare -g _FLAG_DO_EXECUTE_BACKUPS=true
    declare -g _FLAG_DO_EXECUTE_PRE_SETUP=true
    declare -g _FLAG_DO_EXECUTE_POST_SETUP=true
    declare -g _FLAG_DO_SYSTEM_CHECK=true
# </params>

# <functions>
    function Main
    {
        IsSudoUser || return 1

        # <remarks> Gather arguments. </remarks>
        if ! GetOption "${@}"; then
            GetHelp
            return "${?}"
        fi

        if "${_FLAG_DO_SYSTEM_CHECK}" \
            && ! GetLinuxDistro \
            && ! IsSystemSupported; then
            return 1
        fi

        ExecuteBackups
        ExecuteParseSelection || return "${?}"

        # <remarks> Exit early. </remarks>
        if "${_EXECUTE_VFIO_SETUP_UNINSTALL}"; then
            ExecuteMainSetup
            return "${?}"
        fi

        if "${_FLAG_DO_EXECUTE_PRE_SETUP}"; then
            ExecutePreSetup
        fi

        echo
        ExecuteMainSetup

        if "${_FLAG_DO_EXECUTE_POST_SETUP}"; then
            echo
            ExecutePostSetup
        fi

        return 0
    }
# </functions>

# <main>
    if "${_FLAG_DO_EXECUTE_BACKUPS}"; then
        BackupFiles || exit 1
    fi

    while [[ "${?}" -ne 1 ]]; do
        Main "${@}"
        break
    done

    if [[ "${?}" -eq 1 ]] \
        && "${_FLAG_DO_EXECUTE_BACKUPS}"; then
        RestoreFiles || exit 1
    fi

    exit "${?}"
# </main>
