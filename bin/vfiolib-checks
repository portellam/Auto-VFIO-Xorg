#!/bin/bash sh

#
# Filename:         vfiolib-checks
# Author(s):        Alex Portell <github.com/portellam>
# Maintainer(s):    Alex Portell <github.com/portellam>
#

# <summary> Using </summary>
# <code>
    source vfiolib-common
    source vfiolib-globals
# </code>

# <code>
    function Is_IOMMU_Enabled
    {
        if ! compgen -G "/sys/kernel/iommu_groups/*/devices/*" &> /dev/null; then
            echo -e "$_PREFIX_ERROR System does not support IOMMU groups."
            return 1
        fi
    }

    function Is_KVM_Enabled
    {
        if ! command -v "kvm" &> /dev/null; then
            echo -e "$_PREFIX_ERROR Library 'KVM' is not installed."
            return 1
        fi
    }

    function IsLibvirtInstalled
    {
        if [[ $( systemctl list-units --full -all | grep -Fq libvirtd.service ) ]]; then
            echo -e "$_PREFIX_ERROR Daemon/service 'libvirtd' is not installed."
            return 1
        fi
    }

    function Is_QEMU_Installed
    {
        if ! sudo apt list "qemu" --installed &> /dev/null; then
            echo -e "$_PREFIX_ERROR Library 'QEMU' is not installed."
            return 1
        fi
    }

    function IsSystemdInstalled
    {
        if ! command -v systemd &> /dev/null; then
            echo -e "$_PREFIX_ERROR 'systemd' is not installed."
            return 1
        fi
    }

    function IsVirtualizationEnabled
    {
        if ! LC_ALL=C lscpu | grep Virtualization &> /dev/null \
            && ! grep -E -q --color=auto 'vmx|svm|0xc0f' /proc/cpuinfo &> /dev/null; then
            echo -e "$_PREFIX_ERROR System does not support hardware virtualization."
            return 1
        fi
    }
# </code>

# <params>
    declare -g _IS_SYSTEM_SUPPORTED=false

    if IsSystemdInstalled \
        && IsVirtualizationEnabled \
        && Is_IOMMU_Enabled \
        && IsSystemdInstalled \
        && Is_KVM_Enabled \
        && Is_QEMU_Installed \
        && IsLibvirtInstalled; then
        _IS_SYSTEM_SUPPORTED=true
    fi
# </params>