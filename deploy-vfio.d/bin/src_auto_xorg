#!/bin/false

#
# Filename:       src_auto_xorg
# Description:    Logic to update and install Auto X.Org.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# TODO:
# - [ ] test.
#

#
# sources
#
  declare -g SRC_STR_SCRIPT_DIR="/usr/local/bin/"
  declare -g SRC_STR_SCRIPT_BIN_DIR="${SRC_STR_SCRIPT_DIR}deploy-vfio.d/"

  source "${SRC_STR_SCRIPT_BIN_DIR}src_print"
  source "${SRC_STR_SCRIPT_BIN_DIR}src_git"

#
# logic
#
  #
  # DESC:   Main execution.
  # $1:     do print usage.
  # $2:     do skip.
  # $3:     do force execute.
  # $4:     do force install.
  # $5:     do force uninstall.
  # $6:     do force update.
  # $7:     the execute/install command line arguments as a comma-delimited string.
  # RETURN: If successful, return 0.
  #         If not, return 1.
  #         If any exceptions occur, return 2.
  #
    function src_auto_xorg_main
    {
      local -r str_repo_name="Auto X.Org"
      local -r str_comma_delimited_arguments="${7}"

      if ! is_string "${str_comma_delimited_arguments}"; then
        log_invalid_parameter "str_comma_delimited_arguments"
        return 2
      fi

      local -r str_space_delimited_arguments="$( echo \
        "${str_comma_delimited_arguments}" | \
        sed --regexp-extended 's/[,]+/ /g' \
      )"

      local -r bool_do_force_update="${6}"

      if ! is_bool "${bool_do_force_update}"; then
        log_invalid_parameter "bool_do_force_update"
        return 2
      fi

      local -r bool_do_force_uninstall="${5}"

      if ! is_bool "${bool_do_force_uninstall}"; then
        log_invalid_parameter "bool_do_force_uninstall"
        return 2
      fi

      local -r bool_do_force_install="${4}"

      if ! is_bool "${bool_do_force_install}"; then
        log_invalid_parameter "bool_do_force_install"
        return 2
      fi

      local -r bool_do_force_execute="${3}"

      if ! is_bool "${bool_do_force_execute}"; then
        log_invalid_parameter "bool_do_force_execute"
        return 2
      fi

      local -r bool_do_force_skip="${2}"

      if ! is_bool "${bool_do_force_skip}"; then
        log_invalid_parameter "bool_do_force_skip"
        return 2
      fi

      local -r bool_do_print_usage="${1}"

      if ! is_bool "${bool_do_print_usage}"; then
        log_invalid_parameter "bool_do_print_usage"
        return 2
      fi

      if "${bool_do_print_usage}"; then
        src_auto_xorg_usage_prompt

        if ! src_auto_xorg_execute_usage_prompt; then
          if ! src_auto_xorg_installer_usage_prompt; then
              return 1
          fi
        fi

        return 0
      fi

      if "${bool_do_force_skip}"; then
        print_and_log_output "Skipped ${str_repo_name}."
        return 0
      fi

      if "${bool_do_force_update}"; then
        if ! src_auto_xorg_does_repo_exist "true"; then
          return 1
        fi
      fi

      if "${bool_do_force_install}"; then
        if ! src_auto_xorg_install "${str_arguments}"; then
          return 1
        fi

        return 0
      fi

      if "${bool_do_force_execute}"; then
        if ! src_auto_xorg_execute "${str_arguments}"; then
          return 1
        fi

        return 0
      fi

      if "${bool_do_force_uninstall}"; then
        if ! src_auto_xorg_uninstall; then
          return 1
        fi

        return 0
      fi

      if ! src_auto_xorg_does_repo_exist "false"; then
        return 1
      fi

      if ! src_auto_xorg_install_prompt "${str_space_delimited_arguments}"; then
        return 1
      fi

      if ! src_auto_xorg_execute_prompt "${str_space_delimited_arguments}"; then
        return 1
      fi

      if ! src_auto_xorg_uninstall_prompt; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Checks if git repo exists.
  # $1:     do force download repo.
  # RETURN: If repo exists, return 0.
  #         If false, return 1.
  #         If any exception occurs, return 2.
  #
    function src_auto_xorg_does_repo_exist
    {
      local -r str_repo_name="Auto X.Org"
      local -r str_warn="Could not determine if ${str_repo_name} repository exists."

      log_work "Determining if ${str_repo_name} repository exists..."

      local -r str_last_dir="$( pwd )"
      local -r bool_do_force_download="${1}"

      if ! is_bool "${bool_do_force_download_repo}"; then
        log_invalid_parameter "bool_do_force_download_repo"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      does_this_git_repo_exist \
        "${str_repo_name}" \
        "github.com/portellam/auto-xorg" \
        "${bool_do_force_download}"

      local -ir int_return_code="${?}"

      if ! change_directory "${str_last_dir}"; then
        print_and_log_warn "${str_warn}"
        return 2
      fi

      if [[ "${int_return_code}" -ne 0 ]]; then
        print_and_log_warn "${str_warn}"
        return "${int_return_code}"
      fi

      log_pass "${str_repo_name} repository exists."
      return 0
    }

  #
  # DESC:   Execute Auto X.Org.
  # $*:     the command line arguments as a string.
  # RETURN: If execution is successful, return 0.
  #         If false, return 1.
  #
    function src_auto_xorg_execute
    {
      local -r str_repo_name="Auto X.Org"
      local -r str_fail="Could not execute ${str_repo_name}."
      local -a arr_arguments="$@"
      local str_arguments

      if ! get_delimited_string_from_array "arr_arguments" "str_arguments" " "; then
        print_and_log_fail "${str_fail}"
        return 1
      fi

      if ! go_to_parent_path \
        || ! change_directory "auto-xorg"; then
        print_and_log_fail "${str_fail}"
        return 2
      fi

      log_work "Executing ${str_repo_name}...\n"
      sudo bash auto-xorg "${str_arguments}"

      local -i int_code="${?}"

      echo

      if [[ "${int_code}" -ne 0 ]]; then
        print_and_log_fail "${str_fail}"
        return "${int_code}"
      fi

      log_pass "Executed ${str_repo_name}."
      return 0
    }

  #
  # DESC:   Execute Auto X.Org installer.
  # $*:     the command line arguments as a string.
  # RETURN: If execution is successful, return 0.
  #         If false, return 1.
  #
    function src_auto_xorg_execute_installer
    {
      local -r str_repo_name="Auto X.Org"
      local -r str_warn="Could not execute ${str_repo_name} installer."

      if ! src_auto_xorg_does_repo_exist "false"; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      local -a arr_arguments="$@"
      local str_arguments

      if ! get_delimited_string_from_array "arr_arguments" "str_arguments" " "; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      if ! go_to_parent_path \
        || ! change_directory "auto-xorg"; then
        print_and_log_warn "${str_warn}"
        return 2
      fi

      log_work "Executing ${str_repo_name} installer...\n"
      sudo bash installer.bash "${str_arguments}"

      local -i int_code="${?}"

      echo

      if [[ "${int_code}" -ne 0 ]]; then
        print_and_log_warn "${str_warn}"
        return "${int_code}"
      fi

      log_pass "Executed ${str_repo_name} installer."
      return 0
    }

  #
  # DESC:   Prompt to execute Auto X.Org.
  # $*:     the command line arguments as a string.
  # RETURN: If execution is successful, return 0.
  #         If execution has failed, return 1.
  #         If execution is skipped, return 2.
  #
    function src_auto_xorg_execute_prompt
    {
      local -r str_repo_name="Auto X.Org"

      if ! ask_yes_no_question "Execute ${str_repo_name}?"; then
        print_and_log_output "Skipped execution of ${str_repo_name}."
        return 2
      fi

      if ! src_auto_xorg_execute "${str_arguments}"; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Prompt executable usage.
  # RETURN: If prompt is successful, return 0.
  #         If prompt is not, return 1.
  #
    function src_auto_xorg_execute_usage_prompt
    {
      local -r str_repo_name="Auto X.Org"
      local -r str_bin="auto-xorg"
      local -r str_warn="Could not get usage from ${str_repo_name} executable."

      if ! command -v "${str_bin}" &> /dev/null; then
        log_warn "${str_warn}"
        return 1
      fi

      sudo bash "${str_bin}" --help
      return 0
    }

  #
  # DESC:   Install of Auto X.Org.
  # $*:     the command line arguments as a string.
  # RETURN: If install is successful, return 0.
  #         If false, return 1.
  #
    function src_auto_xorg_install
    {
      local -r str_arguments="${*}"
      local -r str_repo_name="Auto X.Org"

      print_and_log_work "Installing ${str_repo_name}..."

      if ! src_auto_xorg_execute_installer "--install ${str_arguments}"; then
        print_and_log_fail "Could not install ${str_repo_name}."
        return 1
      fi

      print_and_log_pass "Installed ${str_repo_name}"
      return 0
    }

  #
  # DESC:   Prompt to install Auto X.Org.
  # $*:     the command line arguments as a string.
  # RETURN: If install is successful, return 0.
  #         If install has failed, return 1.
  #         If install is skipped, return 2.
  #
    function src_auto_xorg_install_prompt
    {
      local -r str_arguments="${*}"
      local -r str_repo_name="Auto X.Org"

      if ! ask_yes_no_question "Install ${str_repo_name}?"; then
        print_and_log_output "Skipped install of ${str_repo_name}."
        return 2
      fi

      if ! src_auto_xorg_install "${str_arguments}"; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Prompt installer usage.
  # RETURN: If prompt is successful, return 0.
  #         If prompt is not, return 1.
  #
  #
    function src_auto_xorg_installer_usage_prompt
    {
      local -r str_repo_name="Auto X.Org"
      local -r str_warn="Could not get usage from ${str_repo_name} installer."

      if ! src_auto_xorg_does_repo_exist "false"; then
        log_warn "${str_warn}"
        return 1
      fi

      if ! go_to_parent_path \
        || ! change_directory "auto-xorg"; then
        log_warn "${str_warn}"
        return 1
      fi

      sudo bash installer.bash --help
      return 0
    }

  #
  # DESC:   Uninstall Auto X.Org.
  # RETURN: If uninstall is successful, return 0.
  #         If false, return 1.
  #
    function src_auto_xorg_uninstall
    {
      local -r str_repo_name="Auto X.Org"

      print_and_log_work "Uninstalling ${str_repo_name}..."

      if ! src_auto_xorg_execute_installer "--uninstall"; then
        print_and_log_fail "Could not uninstall ${str_repo_name}."
        return 1
      fi

      print_and_log_pass "Uninstalled ${str_repo_name}"
      return 0
    }

  #
  # DESC:   Prompt to uninstall Auto X.Org.
  # RETURN: If uninstall is successful, return 0.
  #         If uninstall has failed, return 1.
  #         If uninstall is skipped, return 2.
  #
    function src_auto_xorg_uninstall_prompt
    {
      local -r str_repo_name="Auto X.Org"

      if ! ask_yes_no_question "Uninstall ${str_repo_name}?"; then
        print_and_log_output "Skipped uninstall of ${str_repo_name}."
        return 2
      fi

      if ! src_auto_xorg_uninstall; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Parse Auto X.Org arguments and options.
  # $1:     the argument and option dictionary as a reference.
  # $2:     the option and value dictionary as a reference.
  # $*:     the options as a string.
  # RETURN: If none or all options are valid, return 0.
  #         If any option is not valid, return 1.
  #         If an exception occurs, return 2.
  #
    function src_auto_xorg_usage
    {
      local -n ref_dict_selected_arguments="${1}"

      if ! is_dict "${ref_dict_selected_arguments}"; then
        log_invalid_parameter "ref_dict_selected_arguments"
        return 2
      fi

      shift

      local -n ref_dict_selected_options="${1}"

      if ! is_dict "${ref_dict_selected_options}"; then
        log_invalid_parameter "ref_dict_selected_options"
        return 2
      fi

      shift

      if ! is_string "${1}"; then
        log_output "No options set."
        return 0
      fi

      while is_string "${1}"; do
        local str_parent="${1}"
        local str_child_key=""
        local str_child_value=""
        shift

        if ! src_auto_xorg_usage_parse_options \
            "${str_parent}" \
            "str_child_key" \
            "str_child_value"; then
            print_and_log_invalid_option "${str_parent}"
            return 1
        fi

        if dict_contains_key_value_pair \
            "ref_dict_selected_arguments" \
            "${str_parent}" \
            "${str_child_key}"; then
          log_invalid_parameter "ref_dict_selected_arguments"
          print_and_log_invalid_option "${str_parent}"
          print_conflicting_options
          return 1
        fi

        if dict_contains_key_value_pair \
            "ref_dict_selected_options" \
            "${str_child_key}" \
            "${str_child_value}"; then
          log_invalid_parameter "ref_dict_selected_options"
          print_and_log_invalid_option "${str_parent}"
          print_conflicting_options
          return 1
        fi

        ref_dict_selected_arguments["${str_parent}"]="${str_child_key}"
        ref_dict_selected_options["${str_child_key}"]="${str_child_value}"
        shift
      done

      return 0
    }

  #
  # DESC:   Parse options.
  # $1:     the parent option as a string.
  # $2:     the child option key as a string reference.
  # $3:     the child option value as a string reference.
  # RETURN: If none or all option are valid, return 0.
  #         If any option is not valid, return 1.
  #
    function src_auto_xorg_usage_parse_options
    {
      local -r str_parent="${1}"
      local -n ref_child_key="${2}"
      local -n ref_child_value="${3}"

      if ! is_string "${str_parent}"; then
        return 0
      fi

      shift

      case "${str_parent}" in
         "execute" | "install" )
          if ! src_auto_xorg_usage_parse_nested_options \
              "${str_parent}" \
              "ref_child_key" \
              "ref_child_value"; then
            return 1
          fi

          return 0
          ;;

        "help" \
          | "skip" \
          | "uninstall" \
          | "update" )
          return 0
          ;;

        * )
          return 1
          ;;
      esac
    }

  #
  # DESC:   Parse nested options.
  # $1:     the parent option as a string.
  # $2:     the child option key as a string reference.
  # $3:     the child option value as a string reference.
  # RETURN: If none or all option are valid, return 0.
  #         If any option is not valid, return 1.
  #
    function src_auto_xorg_usage_parse_nested_options
    {
      local -r str_parent="${1}"
      local -n ref_nested_child_key="${2}"
      local -n ref_nested_child_value="${3}"

      if ! is_string "${str_parent}"; then
        return 0
      fi

      shift
      local str_child_key="$( echo "${*}" | cut --delimiter '=' --fields 1 )"
      local str_child_value="$( echo "${*}" | cut --delimiter '=' --fields 2 )"

      case "${str_parent}" in
        "arguments="* )
          if ! is_string "${str_child_value}"; then
            return 1
          fi
          ;;

        * )
          return 2
          ;;
      esac

      ref_nested_child_key="${str_child_key}"
      ref_nested_child_value="${str_child_value}"
      return 0
    }

  #
  # DESC:   Prompt usage.
  # RETURN: Always return 0.
  #
    function src_auto_xorg_usage_prompt
    {
      echo -e ""\
      "--auto-xorg  Set the video output (should the primary video device be binded "\
        " to vfio-pci).\n"\
      "  help       Print usage."\
      "  install    Install Auto X.Org (set video output at boot-time). Downloads "\
        "installer if absent.\n"\
      "  execute    Execute Auto X.Org (set video output at run-time).\n"\
      "  skip       Skip prompts and do nothing.\n"\
      "  uninstall  Uninstall Auto X.Org.\n"\
      "  update     Download Auto X.Org installer.\n"\
      "  [install/execute] OPTIONS:\n"\
      "    arguments=  Invoke the arguments for Auto X.Org, delimited by comma.\n"\
      "\n"\
      "  Example:\n"\
      "    --auto-xorg install arguments=--arg1,--arg2 Install Auto X.Org with the "\
        "arguments listed.\n"\
      ""

      return 0
    }