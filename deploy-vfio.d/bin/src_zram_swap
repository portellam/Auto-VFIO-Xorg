#!/bin/false

#
# Filename:       src_zram_swap
# Description:    Logic to update and install zram-swap.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# TODO:
# - [ ] place non-ref declarations after validation.
# - [ ] test.
#

#
# sources
#
  declare -g SRC_STR_SCRIPT_DIR="/usr/local/bin/"
  declare -g SRC_STR_SCRIPT_BIN_DIR="${SRC_STR_SCRIPT_DIR}deploy-vfio.d/"

  source "${SRC_STR_SCRIPT_BIN_DIR}src_print"
  source "${SRC_STR_SCRIPT_BIN_DIR}src_git"
  source "${SRC_STR_SCRIPT_BIN_DIR}src_memory"

#
# logic
#
  #
  # DESC:   Main execution.
  # $1:     do print usage.
  # $2:     do skip.
  # $3:     do force modify.
  # $4:     do force install.
  # $5:     do force uninstall.
  # $6:     do force update.
  # $7:     do force restart.
  # $8:     do use calculated fraction.
  # $9:     do use default fraction.
  # $10:     the fraction as a string.
  # $11:    count of reserved memory in kilobytes as an int.
  # RETURN: If successful, return 0.
  #         If not, return 1.
  #         If any exceptions occur, return 2.
  #
    function src_zram_swap_main
    {
      local -r str_repo_name="zram-swap"
      local -r int_reserved_memory_count_kilobytes="${11}"

      if ! is_int "${int_reserved_memory_count_kilobytes}"; then
        log_invalid_parameter "int_reserved_memory_count_kilobytes"
        return 2
      fi

      local -r str_fraction="${10}"

      if ! is_fraction "${str_fraction}"; then
        log_invalid_parameter "str_fraction"
        return 2
      fi

      local -r bool_do_use_default_fraction="${9}"

      if ! is_bool "${bool_do_use_default_fraction}"; then
        log_invalid_parameter "bool_do_use_default_fraction"
        return 2
      fi

      local -r bool_do_use_calculated_fraction="${8}"

      if ! is_bool "${bool_do_use_calculated_fraction}"; then
        log_invalid_parameter "bool_do_use_calculated_fraction"
        return 2
      fi

      local -r bool_do_force_restart="${7}"

      if ! is_bool "${bool_do_force_restart}"; then
        log_invalid_parameter "bool_do_force_restart"
        return 2
      fi

      local -r bool_do_force_update="${6}"

      if ! is_bool "${bool_do_force_modify}"; then
        log_invalid_parameter "bool_do_force_update"
        return 2
      fi

      local -r bool_do_force_uninstall="${5}"

      if ! is_bool "${bool_do_force_uninstall}"; then
        log_invalid_parameter "bool_do_force_uninstall"
        return 2
      fi

      local -r bool_do_force_install="${4}"

      if ! is_bool "${bool_do_force_install}"; then
        log_invalid_parameter "bool_do_force_install"
        return 2
      fi

      local -r bool_do_force_modify="${3}"

      if ! is_bool "${bool_do_force_modify}"; then
        log_invalid_parameter "bool_do_force_modify"
        return 2
      fi

      local -r bool_do_force_skip="${2}"

      if ! is_bool "${bool_do_force_skip}"; then
        log_invalid_parameter "bool_do_force_skip"
        return 2
      fi

      local -r bool_do_print_usage="${1}"

      if ! is_bool "${bool_do_print_usage}"; then
        log_invalid_parameter "bool_do_print_usage"
        return 2
      fi

      if "${bool_do_print_usage}"; then
        src_zram_swap_usage_prompt
        exit 0
      fi

      if "${bool_do_force_skip}"; then
        print_and_log_output "Skipped ${str_repo_name}."
        return 0
      fi

      if "${bool_do_force_update}"; then
        if ! src_zram_swap_does_repo_exist "true"; then
          return 1
        fi
      fi

      if "${bool_do_force_install}"; then
        if ! src_zram_swap_install \
          "${bool_do_force_restart}" \
          "${bool_do_use_calculated_fraction}" \
          "${bool_do_use_default_fraction}" \
          "${str_fraction}" \
          "${int_reserved_memory_count_kilobytes}"; then
          return 1
        fi

        return 0
      fi

      if "${bool_do_force_modify}"; then
        if ! src_zram_swap_modify \
          "${bool_do_force_restart}" \
          "${bool_do_use_calculated_fraction}" \
          "${bool_do_use_default_fraction}" \
          "${str_fraction}" \
          "${int_reserved_memory_count_kilobytes}"; then
          return 1
        fi

        return 0
      fi

      if "${bool_do_force_uninstall}"; then
        if ! src_zram_swap_uninstall; then
          return 1
        fi

        return 0
      fi

      if ! src_zram_swap_does_repo_exist "false"; then
        return 1
      fi

      if ! src_zram_swap_install_prompt \
          "${bool_do_force_restart}" \
          "${bool_do_use_calculated_fraction}" \
          "${bool_do_use_default_fraction}" \
          "${str_fraction}" \
          "${int_reserved_memory_count_kilobytes}"; then
        return 1
      fi

      if ! src_zram_swap_modify_prompt \
          "${bool_do_force_restart}" \
          "${bool_do_use_calculated_fraction}" \
          "${bool_do_use_default_fraction}" \
          "${str_fraction}" \
          "${int_reserved_memory_count_kilobytes}"; then
        return 1
      fi

      if ! src_zram_swap_uninstall_prompt; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Get the calculated fraction.
  # $1:     the fraction as a string reference.
  # $2:     the amount of reserved memory in kilobytes.
  # RETURN: If fraction is valid, return 0.
  #         If not, return 1.
  #         If an exception occurs, return 2.
  #
    function src_zram_swap_calculate_fraction
    {
      log_work "Getting calculated fraction..."

      local -r int_reserved_memory_count_kilobytes="${1}"

      if ! src_zram_swap_is_reserved_memory_valid \
        "${int_reserved_memory_count_kilobytes}"; then
        log_invalid_parameter "int_reserved_memory_count_kilobytes"
        print_and_log_warn "Reserve memory amount is not valid."
        return 2
      fi

      local -n ref_alpha_str_fraction="${1}"

      if ! is_string "${ref_alpha_str_fraction}"; then
        log_invalid_parameter "ref_alpha_str_fraction"
        print_and_log_warn "Could not get fraction."
        return 2
      fi

      local -ir int_zram_swap_available_memory_kilobytes=$(( \
        SRC_MEMORY_INT_CURRENT_FREE_MEMORY_BYTES / 2 \
      ))

      local int_sum_of_reserved_and_requested_memory_kilobytes=$(( \
        int_reserved_memory_count_kilobytes + int_zram_swap_available_memory_kilobytes \
      ))

      if [[ \
        "${int_sum_of_reserved_and_requested_memory_kilobytes}" -ge \
        "${SRC_MEMORY_INT_CURRENT_FREE_MEMORY_BYTES}" \
      ]]; then
        log_invalid_parameter "int_sum_of_reserved_and_requested_memory_kilobytes"
        print_and_log_warn "Total reserved memory count exceeds current free memory".
        return 2
      fi

      #
      # NOTE: First evaluate the ratio of max system memory to the zram-swap
      # available memory, as a decimal to the hundredths place.
      # Then truncate the decimal and return an integer.
      #
        local -r str_max_and_available_memory_fraction=""\
          "${SRC_MEMORY_INT_MAX_FREE_MEMORY_BYTES}/${int_zram_swap_available_memory_kilobytes}"

        local -i int_denominator=$( printf "%.0f" \
          $( echo "scale=2;${str_max_and_available_memory_fraction}" | bc ) \
        )

      #
      # NOTE: If denominator is odd, subtract one.
      #
        if [[ $( expr ${int_denominator} % 2 ) -eq 1 ]]; then
          (( int_denominator-- ))
        fi

      log_output "Denominator: ${int_denominator}"

      if [[ "${int_denominator}" -le 1 ]]; then
        print_and_log_warn "Denominator is less than or equal to one."
        return 1
      fi

      ref_alpha_str_fraction="1/${int_denominator}"
      log_pass "Fraction: ${ref_alpha_str_fraction}"
      return 0
    }

  #
  # DESC:   Checks if git repo exists.
  # $1:     do force download repo.
  # RETURN: If repo exists, return 0.
  #         If false, return 1.
  #         If any exception occurs, return 2.
  #
    function src_zram_swap_does_repo_exist
    {
      local -r str_repo_name="zram-swap"
      local -r str_warn="Could not determine if ${str_repo_name} repository exists."

      log_work "Determining if ${str_repo_name} repository exists..."

      local -r str_last_dir="$( pwd )"
      local -r bool_do_force_download="${1}"

      if ! is_bool "${bool_do_force_download_repo}"; then
        log_invalid_parameter "bool_do_force_download_repo"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      does_this_git_repo_exist \
        "${str_repo_name}" \
        "github.com/foundObjects/zram-swap" \
        "${bool_do_force_download}"

      local -ir int_return_code="${?}"

      if ! change_directory "${str_last_dir}"; then
        print_and_log_warn "${str_warn}"
        return 2
      fi

      if [[ "${int_return_code}" -ne 0 ]]; then
        print_and_log_warn "${str_warn}"
        return "${int_return_code}"
      fi

      log_pass "${str_repo_name} repository exists."
      return 0
    }

  #
  # DESC:   Enable zram-swap device.
  # $1:     do force restart all zram-swap devices.
  # RETURN: If zram-swap device is enabled, return 0.
  #         If not, return 1.
  #         If an exception occurs, return 2.
  #
    function src_zram_swap_enable_device
    {
      local -r str_repo_name="zram-swap"
      log_work "Enabling ${str_repo_name} device(s)..."

      local -r str_warn="Could not enable ${str_repo_name} device(s)."
      local -r bool_do_force_restart="${1}"

      if ! is_bool "${bool_do_force_restart}"; then
        log_invalid_parameter "bool_do_force_restart"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      if ! "${bool_do_force_restart}" \
        && sudo swapon --verbose | grep zram &> /dev/null \
        && sudo swapon --verbose | grep zram &> /dev/null \
        && ! sudo swapon --verbose | grep zram | grep 0B &> /dev/null; then
        print_and_log_output "Skipped enabling ${str_repo_name} device(s)\n"\
          "${str_repo_name} device(s) already in use. Restart system to save changes."

        return 0
      fi

      if sudo swapon --verbose | grep zram &> /dev/null \
        && ! sudo swapoff /dev/zram* &> /dev/null; then
        log_output "Failed to disable ${str_repo_name} device(s)."
        print_and_log_warn "${str_warn}"
        return 1
      fi

      log_pass "Disabled ${str_repo_name} device(s)."

      if ! sudo systemctl daemon-reload &> /dev/null; then
        log_output "Could not update Systemd."
        print_and_log_warn "${str_warn}"
        return 1
      fi

      log_pass "Updated Systemd."

      if ! sudo systemctl restart zram-swap &> /dev/null; then
        log_output "Could not restart ${str_repo_name} service."
        print_and_log_warn "${str_warn}"
        return 1
      fi

      log_pass "Restarted ${str_repo_name} service."

      if ! sudo swapon --verbose | grep zram &> /dev/null; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      log_pass "Enabled ${str_repo_name} device(s)."
      return 0
    }

  #
  # DESC:   Is reserved memory valid
  # $1:     count of reserved memory in kilobytes as an int.
  # RETURN: If amount is valid, return 0.
  #         If not, return 1.
  #
    function src_zram_swap_is_reserved_memory_valid
    {
      local -r int_reserved_memory_count_kilobytes="${1}"

      if ! is_int "${int_reserved_memory_count_kilobytes}" \
        || [[ \
          "${int_reserved_memory_count_kilobytes}" -lt \
          "${SRC_MEMORY_INT_MAX_FREE_MEMORY_BYTES}" \
        ]]; then
        log_invalid_parameter "int_reserved_memory_count_kilobytes"

        print_and_log_warn "Reserved memory count is not valid. "\
          "Size must be less than maximum free memory "\
          "(${SRC_MEMORY_INT_MAX_FREE_MEMORY_BYTES} kilobytes)."
        return 1
      fi

      return 0
    }

  #
  # DESC:   Execute zram-swap installer.
  # $*:     the command line arguments as a string.
  # RETURN: If execution is successful, return 0.
  #         If false, return 1.
  #
    function src_zram_swap_execute_installer
    {
      local -r str_repo_name="zram-swap"
      local -r str_warn="Could not execute ${str_repo_name} installer."

      if ! src_zram_swap_does_repo_exist "false"; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      local -a arr_arguments="$@"
      local str_arguments

      if ! get_delimited_string_from_array "arr_arguments" "str_arguments" " "; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      if ! go_to_parent_path \
        || ! change_directory "zram-swap"; then
        print_and_log_warn "${str_warn}"
        return 2
      fi

      log_work "Executing ${str_repo_name} installer...\n"
      sudo bash install.sh "${str_arguments}"

      local -i int_code="${?}"

      echo

      if [[ "${int_code}" -ne 0 ]]; then
        print_and_log_warn "${str_warn}"
        return "${int_code}"
      fi

      log_pass "Executed ${str_repo_name} installer."
      return 0
    }

  #
  # DESC:   Install zram-swap.
  # $1:     do force restart.
  # $2:     do use calculated fraction.
  # $3:     do use default fraction.
  # $4:     the fraction as a string.
  # $5:     amount of reserved memory in kilobytes as an int.
  # RETURN: If install is successful, return 0.
  #         If install has failed, return 1.
  #         If install is skipped, return 2.
  #
    function src_zram_swap_install
    {
      local -r str_repo_name="zram-swap"
      local -r str_fail="Could not install ${str_repo_name}."

      print_and_log_work "Installing ${str_repo_name}..."

      local -r int_reserved_memory_count_kilobytes="${5}"

      if ! is_int "${int_reserved_memory_count_kilobytes}"; then
        log_invalid_parameter "int_reserved_memory_count_kilobytes"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r str_fraction="${4}"

      if ! is_fraction "${str_fraction}"; then
        log_invalid_parameter "str_fraction"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r bool_do_use_default_fraction="${3}"

      if ! is_bool "${bool_do_use_default_fraction}"; then
        log_invalid_parameter "bool_do_use_default_fraction"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r bool_do_use_calculated_fraction="${2}"

      if ! is_bool "${bool_do_use_calculated_fraction}"; then
        log_invalid_parameter "bool_do_use_calculated_fraction"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r bool_do_force_restart="${1}"

      if ! is_bool "${bool_do_force_restart}"; then
        log_invalid_parameter "bool_do_force_restart"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      if "${bool_do_force_install}" \
        && ! src_zram_swap_execute_installer "--install"; then
        print_and_log_fail "${str_fail}"
        return 1
      fi

      if ! src_zram_swap_modify_configuration \
          "${bool_do_use_default_fraction}" \
          "${bool_do_use_calculated_fraction}" \
          "${str_fraction}" \
          "${int_reserved_memory_count_kilobytes}" \
        || ! src_zram_swap_enable_device \
          "${bool_do_force_restart}"; then
        print_and_log_fail "${str_fail}"
        return "${?}"
      fi

      print_and_log_pass "Installed ${str_repo_name}."
      return 0
    }

  #
  # DESC:   Prompt to install zram-swap.
  # $1:     do force restart.
  # $2:     do use calculated fraction.
  # $3:     do use default fraction.
  # $4:     the fraction as a string.
  # $5:     amount of reserved memory in kilobytes as an int.
  # RETURN: If install is successful, return 0.
  #         If install has failed, return 1.
  #         If install is skipped, return 2.
  #
    function src_zram_swap_install_prompt
    {
      local -r str_repo_name="zram-swap"

      if ! ask_yes_no_question "Install ${str_repo_name}?"; then
        print_and_log_output "Skipped install of ${str_repo_name}."
        return 2
      fi

      if ! src_zram_swap_install "${1}" "${2}" "${3}" "${4}" "${5}"; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Modify zram-swap.
  # $1:     do force restart.
  # $2:     do use calculated fraction.
  # $3:     do use default fraction.
  # $4:     the fraction as a string.
  # $5:     amount of reserved memory in kilobytes as an int.
  # RETURN: If modification is successful, return 0.
  #         If modification has failed, return 1.
  #         If modification is skipped, return 2.
  #
    function src_zram_swap_modify
    {
      local -r str_repo_name="zram-swap"
      local -r str_fail="Could not modify ${str_repo_name}."

      print_and_log_work "Modifying ${str_repo_name}..."

      local -r int_reserved_memory_count_kilobytes="${5}"

      if ! is_int "${int_reserved_memory_count_kilobytes}"; then
        log_invalid_parameter "int_reserved_memory_count_kilobytes"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r str_fraction="${4}"

      if ! is_fraction "${str_fraction}"; then
        log_invalid_parameter "str_fraction"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r bool_do_use_default_fraction="${3}"

      if ! is_bool "${bool_do_use_default_fraction}"; then
        log_invalid_parameter "bool_do_use_default_fraction"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r bool_do_use_calculated_fraction="${2}"

      if ! is_bool "${bool_do_use_calculated_fraction}"; then
        log_invalid_parameter "bool_do_use_calculated_fraction"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      local -r bool_do_force_restart="${1}"

      if ! is_bool "${bool_do_force_restart}"; then
        log_invalid_parameter "bool_do_force_restart"
        print_and_log_fail "${str_fail}"
        return 2
      fi

      if ! src_zram_swap_modify_configuration \
          "${bool_do_use_default_fraction}" \
          "${bool_do_use_calculated_fraction}" \
          "${str_fraction}" \
          "${int_reserved_memory_count_kilobytes}" \
        || ! src_zram_swap_enable_device \
          "${bool_do_force_restart}"; then
        print_and_log_fail "${str_fail}"
        return "${?}"
      fi

      print_and_log_pass "Modified ${str_repo_name}."
      return 0
    }

  #
  # DESC:   Prompt to modify zram-swap.
  # $1:     do force restart.
  # $2:     do use calculated fraction.
  # $3:     do use default fraction.
  # $4:     the fraction as a string.
  # $5:     amount of reserved memory in kilobytes as an int.
  # RETURN: If modification is successful, return 0.
  #         If modification has failed, return 1.
  #         If modification is skipped, return 2.
  #
    function src_zram_swap_modify_prompt
    {
      local -r str_repo_name="zram-swap"

      if ! ask_yes_no_question "Modify ${str_repo_name}?"; then
        print_and_log_output "Skipped modification of ${str_repo_name}."
        return 2
      fi

      if ! src_zram_swap_modify "${1}" "${2}" "${3}" "${4}" "${5}"; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Modify configuration files for zram-swap.
  # $1:     do use the default fraction value.
  # $2:     do use calculated fraction value.
  # $3:     the fraction as a string.
  # $4:     count of reserved memory in kilobytes as an int.
  # RETURN: If output is valid and file is written, return 0.
  #         If not, return 1.
  #         If an exception occurs, return 2.
  #
    function src_zram_swap_modify_configuration
    {
      local -r str_repo_name="zram-swap"
      local -r str_warn="Could not modify ${str_repo_name} configuration."

      log_work "Modifying ${str_repo_name} configuration..."

      local int_reserved_memory_count_kilobytes="${4}"

      if ! is_int "${int_reserved_memory_count_kilobytes}"; then
        log_invalid_parameter "int_reserved_memory_count_kilobytes"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      local str_fraction="${3}"

      if is_string "${str_fraction}" \
        && ! is_fraction "${str_fraction}"; then
        log_invalid_parameter "str_fraction"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      local bool_do_use_calculated_fraction="${2}"

      if ! is_bool "${bool_do_use_calculated_fraction}"; then
        log_invalid_parameter "bool_do_use_calculated_fraction"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      local bool_do_use_default_fraction="${1}"

      if ! is_bool "${bool_do_use_default_fraction}"; then
        log_invalid_parameter "bool_do_use_default_fraction"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      if ! is_fraction "${str_fraction}"; then
        if "${bool_do_use_calculated_fraction}"; then
          if ! src_zram_swap_calculate_fraction \
            "${str_fraction}" "${int_reserved_memory_count_kilobytes}"; then
            print_and_log_warn "${str_warn}"
            return 1
          fi

        else
          if ! src_zram_swap_set_fraction_prompt \
            "str_fraction" \
            "${bool_do_use_default_fraction}"; then
            print_and_log_warn "${str_warn}"
            return 2
          fi
        fi

      else
        if ! is_absolute_value_of_fraction_less_than_one "${str_fraction}"; then
          print_and_log_warn "${str_warn}"
          return 2
        fi
      fi

      local -r str_file_path="/etc/default/zram-swap"
      local -r str_line_to_match="_zram_fraction="

      if ! sed -i \
        '/'${str_line_to_match}'"*"/c\'${str_line_to_match}'"'${str_fraction}'"' \
        "${str_file_path}"; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      log_pass "Modified ${str_repo_name} configuration."
      return 0
    }

  #
  # DESC:   Set zram-swap fraction size.
  # $1:     the fraction as a string reference.
  # $2:     do use the default fraction value.
  # RETURN: If zram-swap fraction size is valid, return 0.
  #         If not, return 1.
  #         If an exception occurs, return 2.
  #
    function src_zram_swap_set_fraction
    {
      local -r str_repo_name="zram-swap"
      local -r str_warn="Could not set ${str_repo_name} fraction value."

      print_and_log_work "Setting ${str_repo_name} fraction value..."

      if ! is_any_host_memory_available; then
        print_and_log_warn "${str_warn}"
        return 2
      fi

      local bool_do_use_default="${2}"

      if ! is_bool "${bool_do_use_default}"; then
        log_invalid_parameter "bool_do_use_default"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      local -n ref_beta_str_fraction="${1}"

      if ! is_string "${ref_beta_str_fraction}"; then
        log_invalid_parameter "ref_beta_str_fraction"
        print_and_log_warn "${str_warn}"
        return 2
      fi

      local -r str_default_fraction="1/2"

      if "${bool_do_use_default}"; then
        ref_beta_str_fraction="${str_default_fraction}"
        log_pass "Set fraction to default: ${str_default_fraction}"
        return 0
      fi

      if ! is_absolute_value_of_fraction_less_than_one \
        "${ref_beta_str_fraction}"; then
        print_and_log_warn "${str_warn}"
        return 1
      fi

      log_pass "Set fraction: ${ref_beta_str_fraction}"
      return 0
    }

  #
  # DESC:   Set zram-swap value by user input.
  # $1:     the fraction as a string reference.
  # $2:     do use the default fraction value.
  # RETURN: If zram-swap value is valid, return 0.
  #         If not, return 1.
  #         If an exception occurs, return 2.
  #
    function src_zram_swap_set_fraction_prompt
    {
      local -r str_repo_name="zram-swap"

      local bool_do_use_default="${2}"

      if ! is_bool "${bool_do_use_default}"; then
        log_invalid_parameter "bool_do_use_default"
        return 2
      fi

      local -n ref_alpha_str_fraction="${1}"

      if ! is_string "${1}"; then
        log_invalid_parameter "1"
        return 2
      fi

      local -r str_default_fraction="1/2"

      if "${bool_do_use_default}"; then
        src_zram_swap_set_fraction "${ref_alpha_str_fraction}" "${bool_do_use_default}"
        return 0
      fi

      local -ir int_max_tries=2

      for int_count in $( seq 0 "${int_max_tries}" ); do
        read -r -p "Set fraction of total memory for ${str_repo_name} to use " \
          "(to calculate default, enter 'default'): " \
          ref_alpha_str_fraction

        if [[ "${ref_alpha_str_fraction}" == "default" ]]; then
          bool_do_use_default=true
        fi

        if src_zram_swap_set_fraction "${ref_alpha_str_fraction}" \
          "${bool_do_use_default}"; then
          return 0
        fi
      done

      print_and_log_warn "Not a fraction or invalid input."
      return 1
    }

  #
  # DESC:   Uninstall zram-swap.
  # RETURN: If uninstall is successful, return 0.
  #         If uninstall has failed, return 1.
  #         If uninstall is skipped, return 2.
  #
    function src_zram_swap_uninstall
    {
      if ! src_zram_swap_execute_installer "--uninstall"; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Prompt to uninstall zram-swap.
  # RETURN: If uninstall is successful, return 0.
  #         If uninstall has failed, return 1.
  #         If uninstall is skipped, return 2.
  #
    function src_zram_swap_uninstall_prompt
    {
      local -r str_repo_name="zram-swap"

      if ! ask_yes_no_question "Uninstall ${str_repo_name}?"; then
        print_and_log_output "Skipped uninstall of ${str_repo_name}."
        return 2
      fi

      if ! src_zram_swap_uninstall; then
        return 1
      fi

      return 0
    }

  #
  # DESC:   Parse zram-swap arguments and options.
  # $1:     the argument and option dictionary as a reference.
  # $2:     the option and value dictionary as a reference.
  # $*:     the options as a string.
  # RETURN: If none or all options are valid, return 0.
  #         If any option is not valid, return 1.
  #         If an exception occurs, return 2.
  #
    function src_zram_swap_usage
    {
      local -n ref_dict_selected_arguments="${1}"

      if ! is_dict "${ref_dict_selected_arguments}"; then
        log_invalid_parameter "ref_dict_selected_arguments"
        return 2
      fi

      shift

      local -n ref_dict_selected_options="${1}"

      if ! is_dict "${ref_dict_selected_options}"; then
        log_invalid_parameter "ref_dict_selected_options"
        return 2
      fi

      shift

      if ! is_string "${1}"; then
        log_output "No options set."
        return 0
      fi

      while is_string "${1}"; do
        local str_parent="${1}"
        local str_child_key=""
        local str_child_value=""
        shift

        if ! src_zram_swap_usage_parse_options \
            "${str_parent}" \
            "str_child_key" \
            "str_child_value"; then
            print_and_log_invalid_option "${str_parent}"
            return 1
        fi

        if dict_contains_key_value_pair \
            "ref_dict_selected_arguments" \
            "${str_parent}" \
            "${str_child_key}"; then
          log_invalid_parameter "ref_dict_selected_arguments"
          print_and_log_invalid_option "${str_parent}"
          print_conflicting_options
          return 1
        fi

        if dict_contains_key_value_pair \
            "ref_dict_selected_options" \
            "${str_child_key}" \
            "${str_child_value}"; then
          log_invalid_parameter "ref_dict_selected_options"
          print_and_log_invalid_option "${str_parent}"
          print_conflicting_options
          return 1
        fi

        ref_dict_selected_arguments["${str_parent}"]="${str_child_key}"
        ref_dict_selected_options["${str_child_key}"]="${str_child_value}"
        shift
      done

      return 0
    }

  #
  # DESC:   Parse options.
  # $1:     the parent option as a string.
  # $2:     the child option key as a string reference.
  # $3:     the child option value as a string reference.
  # RETURN: If none or all option are valid, return 0.
  #         If any option is not valid, return 1.
  #
    function src_zram_swap_usage_parse_options
    {
      local -r str_parent="${1}"
      local -n ref_child_key="${2}"
      local -n ref_child_value="${3}"

      if ! is_string "${str_parent}"; then
        return 0
      fi

      shift

      case "${str_parent}" in
        "install" | "modify" )
          if ! src_zram_swap_usage_parse_nested_options \
              "${str_parent}" \
              "ref_child_key" \
              "ref_child_value"; then
            return 1
          fi

          return 0
          ;;

        "help" \
          | "skip" \
          | "uninstall" \
          | "update" )
          return 0
          ;;

        * )
          return 1
          ;;
      esac
    }

  #
  # DESC:   Parse nested options.
  # $1:     the parent option as a string.
  # $2:     the child option key as a string reference.
  # $3:     the child option value as a string reference.
  # RETURN: If none or all option are valid, return 0.
  #         If any option is not valid, return 1.
  #
    function src_zram_swap_usage_parse_nested_options
    {
      local -r str_parent="${1}"
      local -n ref_nested_child_key="${2}"
      local -n ref_nested_child_value="${3}"

      if ! is_string "${str_parent}"; then
        return 0
      fi

      shift
      local str_child_key="$( echo "${*}" | cut --delimiter '=' --fields 1 )"
      local str_child_value="$( echo "${*}" | cut --delimiter '=' --fields 2 )"

      case "${str_parent}" in
        "restart" )
          return 0
          ;;

        "fraction="* )
          if ! is_fraction "${str_child_value}" \
            && [[ "${str_child_value}" == "default" ]]; then
            return 1
          fi
          ;;

        "hugepages-count="* )
          if ! is_int "${str_child_value}"; then
            return 1
          fi
          ;;

        "hugepages-size="* )
          if ! src_hugepages_get_kilobytes_size \
              "${str_child_value}" \
              "ref"; then
            return 1
          fi
          ;;

        * )
          return 2
          ;;
      esac

      ref_nested_child_key="${str_child_key}"
      ref_nested_child_value="${str_child_value}"
      return 0
    }

  #
  # DESC:   Prompt usage.
  # RETURN: Always return 0.
  #
    function src_zram_swap_usage_prompt
    {
      echo -e ""\
      "--zram-swap  Compress page memory in RAM with the (default) fast algorithm "\
        "'lz4' (compression ratio of 5:2).\n"\
      "  help       Print usage.\n"\
      "  install    Install zram-swap. Downloads installer if absent.\n"\
      "  modify     Modify the existing installation.\n"\
      "  skip       Skip prompts and do nothing.\n"\
      "  uninstall  Uninstall zram-swap.\n"\
      "  update     Download zram-swap installer.\n"\
      "  [install/modify OPTIONS]:\n"\
      "    fraction=         Set the fraction of total memory to allocate as "\
        "zram-swap. Overrides the default value.\n"\
      "    hugepages-count=  The count of Hugepages. Append any positive number.\n"\
      "    hugepages-size=   The size of a Hugepage in bytes with a metric prefix "\
        "(4K/2M/1G).\n"\
      "\n"\
      "    restart           Restart any active zram-swap devices."\
      "    [fraction=VALUES]:\n"\
      "      x/y         A fraction between 0 and 1.\n"\
      "      calculated  Caclulate a fraction value given defined logic.\n"\
      ""

      return 0
    }