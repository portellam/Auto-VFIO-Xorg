#!/bin/false

#
# Filename:       src_iommu_device_getters
# Description:    Getters for IOMMU group device information.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# sources
#
  declare -g SRC_STR_SCRIPT_DIR="/usr/local/bin/"
  declare -g SRC_STR_SCRIPT_BIN_DIR="${SRC_STR_SCRIPT_DIR}deploy-vfio.d/"

  source "${SRC_STR_SCRIPT_BIN_DIR}src_print"
  source "${SRC_STR_SCRIPT_BIN_DIR}src_iommu_device_validation"

#
# setter logic
#
  #
  # DESC: globals
  #
    function set_globals
    {
      if [[ "${SRC_IOMMU_PARSE_BOOL_SET_GLOBALS}" == true ]]; then
        return 0
      fi

      declare -g SRC_IOMMU_PARSE_BOOL_SET_GLOBALS=true

      declare -gr SRC_IOMMU_PARSE_STR_GET_DEVICES_FOR_IOMMU_GROUP=$( \
        ls "/sys/kernel/iommu_groups/"'${int_iommu_group_id}'"/devices" \
      )
    }

#
# logic
#
  #
  # DESC:   Get device class.
  # $1:     the device info as a string.
  # $2:     the reference variable.
  # RETURN: If device class is found, return 0.
  #         If not, return 1.
  #
    function get_device_class
    {
      local -r str_device="${1}"
      local -n ref="${2}"

      ref="$( lspci -ms ${str_device} | cut --delimiter '"' --fields 2 )"
    }

  #
  # DESC:   Get the device driver.
  # $1:     the device info as a string.
  # $2:     the reference variable.
  # $3:     the reference of dictionary of device drivers from XML file.
  # RETURN: If device driver is found, return 0.
  #         If not, return 1.
  #
    function get_device_driver
    {
      local bool_do_parse_from_xml_file=false

      if ! is_dict "${3}"; then
        bool_do_parse_from_xml_file=false

        print_output_to_log "Missing dictionary of device drivers from XML file."\
          "Parsing from internal database."
      else
        bool_do_parse_from_xml_file=true

        print_output_to_log "Parsing from XML file."
      fi

      if ! is_string "${2}"; then
        print_error_to_log "Invalid reference."
        return 1
      fi

      if ! is_string "${1}"; then
        print_error_to_log "Invalid device."
        return 1
      fi

      local -r str_device="${1}"
      local -n ref="${2}"
      local -n ref_dict_device_drivers_from_xml_file="${3}"

      if "${bool_do_parse_from_xml_file}"; then
        ref="${ref_dict_device_drivers_from_xml_file["${str_device}"]}"

        if ! dict_contains_key "ref_dict_device_drivers_from_xml_file" \
          "${str_device}" &> /dev/null; then
          print_error_to_log "Could not find device driver from XML file."
          return 1
        fi

      else
        ref="$( \
          lspci -ks "${str_device}" | grep --ignore-case "driver" | \
          awk 'END {print $5}' \
        )"
      fi

      return 0
    }

  #
  # DESC:   Get device hardware ID.
  # $1:     the device info as a string.
  # $2:     the reference variable.
  # RETURN: If device hardware ID is found, return 0.
  #         If not, return 1.
  #
    function get_device_hardware_id
    {
      local -r str_device="${1}"
      local -n ref="${2}"

      ref="$( lspci -ns ${str_device} | cut --delimiter ' ' --fields 3 )"
    }

  #
  # DESC:   Get device name.
  # $1:     the device info as a string.
  # $2:     the reference variable.
  # RETURN: If device name is found, return 0.
  #         If not, return 1.
  #
    function get_device_name
    {
      local -r str_device="${1}"
      local -n ref="${2}"

      ref="$( lspci -ms ${str_device}  | cut --delimiter '"' --fields 6 )"
    }

  #
  # DESC:   Get device vendor.
  # $1:     the device info as a string.
  # $2:     the reference variable.
  # RETURN: If device vendor is found, return 0.
  #         If not, return 1.
  #
    function get_device_vendor
    {
      local -r str_device="${1}"
      local -n ref="${2}"

      ref="$( lspci -ms ${str_device} | cut --delimiter '"' --fields 4 )"
    }

  #
  # DESC:   Get device info as dictionaries given selection.
  # $1:     the reference of IOMMU group IDs array.
  # $2:     the reference of the device driver dictionary.
  # $3:     the reference of the device pci-stub hardware ID dictionary.
  # $4:     the reference of the device vfio-pci hardware ID dictionary.
  # RETURN: If drivers and/or hardware IDs are found, return 0.
  #         If not, return 1.
  #
    function get_device_dictionaries_for_selection
    {
      local -n ref="${1}"
      local -n ref_dict_driver="${2}"
      local -n ref_dict_stub_hwid="${3}"
      local -n ref_dict_vfio_hwid="${4}"

      for int_iommu_group_id in ${ref[@]}; do
        local -a arr_device_list="$( \
          eval "${SRC_IOMMU_PARSE_STR_GET_DEVICES_FOR_IOMMU_GROUP}" \
        )"

        for str_device in ${arr_device_list[@]}; do
          local str_driver=""
          local str_hwid=""

          get_device_driver       "${str_device}" "str_driver"
          get_device_hardware_id  "${str_device}" "str_hwid"

          if [[ ! -z "${str_driver}" ]] \
            && is_device_not_excluded "${str_device}"; then
            ref_dict_driver+=( "${str_driver}" )
          fi

          if [[ ! -z "${str_hwid}" ]]; then
            if is_device_for_pci_stub "${str_device}"; then
              ref_dict_stub_hwid+=( "${str_hwid}" )
            else
              ref_dict_vfio_hwid+=( "${str_hwid}" )
            fi
          fi
        done
      done

      ref_dict_driver=( $( sort --unique <<<"${ref_dict_driver[*]}" ) )
      ref_dict_stub_hwid=( $( sort --unique <<<"${ref_dict_stub_hwid[*]}" ) )
      ref_dict_vfio_hwid=( $( sort --unique <<<"${ref_dict_vfio_hwid[*]}" ) )

      if is_enum_not_empty "ref_dict_driver"; then
        return 0
      fi

      if is_enum_not_empty "ref_dict_stub_hwid" \
        || is_enum_not_empty "ref_dict_vfio_hwid"; then
        print_error_to_log "No drivers or hardware IDs found for selection."
        return 1
      fi

      return 0
    }

  #
  # DESC:   Get name for fist VGA device in IOMMU group.
  # $1:     the IOMMU group ID as an int.
  # $2:     the reference of the device name as a string.
  # RETURN: If the device name is found, return 0.
  #         If not, return 1.
  #
    function get_name_for_first_vga_device_in_iommu_group
    {
      if [[ -z "${2}" ]] \
        || ! is_int "${1}" &> /dev/null; then
        return 1
      fi

      local -ir int_iommu_group_id="${1}"
      local -n ref_str_device_name="${2}"

      local -ar arr_device_list="$( \
        eval "${SRC_IOMMU_PARSE_STR_GET_DEVICES_FOR_IOMMU_GROUP}" \
      )"

      local str_name=""

      for str_device in ${arr_device_list[@]}; do
        if ! is_device_vga "${str_device}"; then
          continue
        fi

        if get_device_name "${str_device}" "ref_str_device_name"; then
          break
        fi
      done

      if [[ -z "${str_name}" ]]; then
        print_error_to_log "Could not find device name of any VGA device in "\
          "IOMMU group ${int_iommu_group_id}."

        return 1
      fi

      ref_str_device_name="${str_name}"
    }

#
# main logic
#
  set_globals
  unset set_globals