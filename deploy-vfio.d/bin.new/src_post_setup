#!/bin/false

#
# Filename:       src_post_setup
# Description:    Post setup logic.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# sources
#
  declare -g SCRIPT_DIR="/usr/local/bin/"
  declare -g SCRIPT_BIN_DIR="${SCRIPT_DIR}deploy-vfio.d/"

  source "${SCRIPT_BIN_DIR}src_print"
  source "${SCRIPT_BIN_DIR}src_auto_xorg"
  source "${SCRIPT_BIN_DIR}src_libvirt_hooks"
  source "${SCRIPT_BIN_DIR}src_looking_glass"
  source "${SCRIPT_BIN_DIR}src_zram_swap"

#
# setter logic
#
  #
  # DESC: globals
  #
    function set_globals
    {
      if [[ "${BOOL_SRC_POST_SETUP_SET_GLOBALS}" == true ]]; then
        return 0
      fi

      declare -g BOOL_SRC_POST_SETUP_SET_GLOBALS=true

      declare -g BOOL_DO_INSTALL_AUDIO_LOOPBACK=true
      declare -g BOOL_DO_INSTALL_AUTO_XORG=true
      declare -g BOOL_DO_INSTALL_LIBVIRT_HOOKS=true
      declare -g BOOL_DO_INSTALL_LOOKING_GLASS=true
      declare -g BOOL_DO_INSTALL_ZRAM_SWAP=true
      declare -g STR_AUTO_XORG_ARGUMENTS=""
    }

#
# Logic
#
  #
  # DESC:   Is Linux distribution supported.
  # RETURN: If true, return 0. If false, return 1.
  #
  function execute_post_setup
  {
    is_git_installed
    does_git_parent_path_exist || return 1

    if "${BOOL_DO_INSTALL_AUTO_XORG}"; then
      execute_auto_xorg_installer "${STR_AUTO_XORG_ARGUMENTS}"
    else
      uninstall_auto_xorg
    fi

    if "${BOOL_DO_INSTALL_LIBVIRT_HOOKS}"; then
      install_libvirt_hooks
    else
      uninstall_libvirt_hooks
    fi

    if "${BOOL_DO_INSTALL_LOOKING_GLASS}"; then
      install_looking_glass
    # else
    #   uninstall_looking_glass
    fi

    if "${BOOL_DO_INSTALL_ZRAM_SWAP}"; then
      install_zram_swap
    # else
    #   uninstall_zram_swap
    fi

    return 0
  }

#
# main logic
#
  set_globals
  unset set_globals

#
# notes:
#
# - [x] make a source file for downloading, installing, and modifying each repo.
#
# - [x] add args to beginning of main, so that this script can be run on its' own,
#  without deploy-vfio.
#
# - [x] check if git exists
#   - [x] if not, attempt to install
#     - [x] if internet cannot be reached, log error and exit.
#     - [x] if that fails, warn user, log error and exit.
#
# - [x] if git repos exist locally,
#   - [x] first, ask user to check for updates for all.
#     - [x] if yes...
#       - [x] if internet cannot be reached, log error and exit.
#       - [x] if given repo fails to update, rollback.
#   - [x] second, ask to download each repo.
#     - [x] if install fails for one, rollback changes, log error, and continue.
#
# - [x] if git repos do not exist locally,
#   - [x] first, download each repo.
#     - [x] if internet cannot be reached, log error and exit.
#   - [x] second, ask to download each repo.
#     - [x] if download fails for one, rollback changes, log error, and continue.
#
# - [x] add logger
#   - [x] escalate by type, general output, warn, error, failure, success.
#
# - [ ] add repos
#   - [ ] "Audio Loopback"  "github.com/portellam/audio-loopback"
#   - [ ] "Scream"          "github.com/duncanthrax/scream"
#