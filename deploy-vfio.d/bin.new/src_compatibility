#!/bin/false

#
# Filename:       src_compatibility
# Description:    System checks and validation.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# TODO:
# - [ ] test.
#

#
# sources
#
  declare -g SRC_STR_SCRIPT_DIR="/usr/local/bin/"
  declare -g SRC_STR_SCRIPT_BIN_DIR="${SRC_STR_SCRIPT_DIR}deploy-vfio.d/"

  source "${SRC_STR_SCRIPT_BIN_DIR}src_print"

#
# setter logic
#
  #
  # DESC: globals
  #
    function set_globals
    {
      if [[ "${SRC_COMPATIBILITY_BOOL_SET_GLOBALS}" == true ]]; then
        return 0
      fi

      declare -g SRC_COMPATIBILITY_BOOL_SET_GLOBALS=true

      declare SRC_COMPATIBILITY_BOOL_DO_IGNORE_DISTRO=false
    }

#
# Argument logic
#
  #
  # DESC:   Set flag to true if argument is passed.
  # $1:     the argument as a string.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #         If argument is invalid, return 2.
  #
    function is_option_ignore_distro
    {
      if [[ "${1}" != "--ignore-distro" ]]; then
        SRC_COMPATIBILITY_BOOL_DO_IGNORE_DISTRO=false
        log_output "Enabled system distribution check."
        return 1
      fi

      if is_string "${1}"; then
        print_and_log_warn "Invalid argument. Valid arguments: --ignore-distro"
        return 2
      fi

      log_output "Disabled system distribution check."
      SRC_COMPATIBILITY_BOOL_DO_IGNORE_DISTRO=true
      return 0
    }

  #
  # DESC:   Call option logic.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_option_of_compatibility
    {
      if ! is_option_ignore_distro; then
        return 1
      fi

      return 0
    }

#
# Logic
#
  #
  # DESC:   Is Linux distribution supported.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_distribution_supported
    {
      if "${SRC_COMPATIBILITY_BOOL_DO_IGNORE_DISTRO}"; then
        log_to_stdout "Skipped system distribution support check."
        return 0
      fi

      local -r str_operating_system="$( lsb_release --id --short )"
      local -lr str_operating_system_lowercase="${str_operating_system}"

      if [[ "${str_operating_system_lowercase}" != *"debian"* ]] \
        && [[ "${str_operating_system_lowercase}" != *"ubuntu"* ]]; then
        print_and_log_warn "System distribution " \
          "'${str_operating_system_lowercase}' is not explicitly supported."

        return 1
      fi

      log_pass "System distribution '${str_operating_system_lowercase}' "\
        "is supported."

      return 0
    }

  #
  # DESC:   Is IOMMU support groups supported by the Host machine.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_iommu_enabled
    {
      if ! compgen -G "/sys/kernel/iommu_groups/*/devices/*" &> /dev/null; then
        print_and_log_warn "System does not support IOMMU groups."
        return 1
      fi

      log_pass "System does support IOMMU groups."
      return 0
    }

  #
  # DESC:   Is given package installed as a command or in the APT package manager.
  # $1:     the package name as a string
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_package_installed
    {
      local str_package_name="${1}"

      if command -v "${str_package_name}" &> /dev/null; then
        log_pass "Package '${str_package_name}' is installed."
        return 0
      fi

      if ! sudo apt list --installed "${str_package_name}" | \
        grep "${str_package_name}" &> /dev/null; then
        print_and_log_warn "Package '${str_package_name}' is not installed."
        return 1
      fi

      log_pass "Package '${str_package_name}' is installed."
      return 0
    }

  #
  # DESC:   Is the Host machine supported in general.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_system_supported
    {
      if ! is_virtualization_enabled \
        || ! is_iommu_enabled \
        || ! is_systemd_installed \
        || ! is_xml_library_installed \
        || ! is_distribution_supported; then
        print_and_log_warn "System is not supported."
        exit 1
      fi

      log_pass "System is supported."
      return 0
    }

  #
  # DESC:   Is Systemd installed (yuck!).
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_systemd_installed
    {
      if ! command -v systemd &> /dev/null; then
        print_and_log_warn "'systemd' is not installed."
        return 1
      fi

      log_pass "'systemd' is installed."
      return 0
    }

  #
  # DESC:   Is Virtualization enabled on the Host machine.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_virtualization_enabled
    {
      if ! LC_ALL=C lscpu | grep --ignore-case Virtualization &> /dev/null \
        && ! grep --extended-regexp --quiet --color=auto 'vmx|svm|0xc0f' \
          /proc/cpuinfo &> /dev/null; then
        print_and_log_warn "System does not or cannot support hardware " \
          "virtualization."

        return 1
      fi

      log_pass "System supports hardware virtualization."
      return 0
    }

  #
  # DESC:   Is the required libraries installed.
  # RETURN: If true, return 0.
  #         If false, return 1.
  #
    function is_xml_library_installed
    {
      if ! command -v "xmlstarlet" &> /dev/null; then
        print_and_log_warn "Required XML libraries are not installed."

        print_and_log_output "To install, execute 'sudo apt install -y  \
          xmlstarlet'."

        return 1
      fi

      log_pass "Required XML libraries are installed."
      return 0
    }

#
# main logic
#
  set_globals
  unset set_globals