#!/bin/false

#
# Filename:       src_auto_xorg
# Description:    Logic to update and install Auto X.Org.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
#

#
# TODO:
# - [ ] test.
# - [ ] have this class only install/uninstall Auto X.Org?
#

#
# sources
#
  declare -g SRC_STR_SCRIPT_DIR="/usr/local/bin/"
  declare -g SRC_STR_SCRIPT_BIN_DIR="${SRC_STR_SCRIPT_DIR}deploy-vfio.d/"

  source "${SRC_STR_SCRIPT_BIN_DIR}src_print"
  source "${SRC_STR_SCRIPT_BIN_DIR}src_git"

#
# logic
#
  #
  # DESC:   Checks if git repo exists.
  # RETURN: If repo exists, return 0.
  #         If false, return 1.
  #
    function does_auto_xorg_repo_exist
    {
      log_stdout "${0}: ${FUNCNAME}"

      local -r str_last_dir="$( pwd )"
      does_this_git_repo_exist "Auto X.Org" "github.com/portellam/auto-xorg"
      cd "${str_last_dir}"
    }

  #
  # DESC:   Execute Auto X.Org.
  # $*:     the command line arguments as a string.
  # RETURN: If execution is successful, return 0.
  #         If false, return 1.
  #
    function execute_auto_xorg
    {
      log_stdout "${0}: ${FUNCNAME}"

      if ! does_auto_xorg_repo_exist; then
        return 1
      fi

      local -a arr_arguments="$@"
      local str_arguments

      if ! src_auto_xorg_parse_arguments "$@" \
        || ! get_delimited_string_from_array "arr_arguments" "str_arguments" " "; then
        return 1
      fi

      cd "${str_project_path}"
      log_stdout "Executing Auto X.Org...\n"
      sudo bash auto-xorg "${str_arguments}"

      local -i int_code="${?}"

      echo

      if [[ "${int_code}" -ne 0 ]]; then
        log_stderr "Execution failed."
        return "${int_code}"
      fi

      log_stdout "Execution successful."
      return 0
    }

  #
  # DESC:   Execute Auto X.Org installer.
  # $*:     the command line arguments as a string.
  # RETURN: If execution is successful, return 0.
  #         If false, return 1.
  #
    function execute_auto_xorg_installer
    {
      log_stdout "${0}: ${FUNCNAME}"

      if ! does_auto_xorg_repo_exist; then
        return 1
      fi

      local -a arr_arguments="$@"
      local str_arguments

      if ! src_auto_xorg_parse_installer_arguments "$@" \
        || ! get_delimited_string_from_array "arr_arguments" "str_arguments" " "; then
        return 1
      fi

      cd "${str_project_path}"
      log_stdout "Executing Auto X.Org installer...\n"
      sudo bash installer.bash "${str_arguments}"

      local -i int_code="${?}"

      echo

      if [[ "${int_code}" -ne 0 ]]; then
        log_stderr "Execution failed."
        return "${int_code}"
      fi

      log_stdout "Execution successful."
      return 0
    }

  #
  # DESC:   Install of Auto X.Org, no added arguments.
  # $*:     the command line arguments as a string.
  # RETURN: If install is successful, return 0.
  #         If false, return 1.
  #
    function install_auto_xorg
    {
      log_stdout "${0}: ${FUNCNAME}"

      local -r str_arguments="${*}"

      print_output_to_log "Installing Auto X.Org..."

      if ! execute_auto_xorg_installer "--install ${str_arguments}"; then
        print_output_to_log "Failed."
        return 1
      fi

      print_output_to_log "Successful."
      return 0
    }

  #
  # DESC:   Parse arguments for executable.
  # $*:     the arguments as a string.
  # RETURN: If parse is successful, return 0
  #         If not, return 1.
  #
    function src_auto_xorg_parse_arguments
    {
      while [[ ! -z "${1}" ]]; do
        if ! src_auto_xorg_parse_argument "$@"; then
          return 1
        fi

        shift
      done

      return 0
    }

  #
  # DESC:   Parse argument for executable.
  # $*:     the arguments as a string.
  # RETURN: If argument is empty or valid, return 0.
  #         If argument is not valid or there exists conflicting arguments, return 1.
  #
    function src_auto_xorg_parse_argument
    {
      if ! is_string "${1}"; then
        return 0
      fi

      local -ar arr_arguments=$@

      if array_contains_value "arr_arguments" "--first" \
        && array_contains_value "arr_arguments" "--last"; then
        print_conflicting_options
        return 1
      fi

      if array_contains_value "arr_arguments" "--amd" \
        && array_contains_value "arr_arguments" "--intel" \
        && array_contains_value "arr_arguments" "--nvidia" \
        && array_contains_value "arr_arguments" "--other"; then
        print_conflicting_options
        return 1
      fi

      if is_string "${1}"; then
        print_invalid_argument "${1}"
        return 1
      fi

      return 0
    }

  #
  # DESC:   Parse arguments for installer.
  # $*:     the arguments as a string.
  # RETURN: If parse is successful, return 0
  #         If not, return 1.
  #
    function src_auto_xorg_parse_installer_arguments
    {
      while [[ ! -z "${1}" ]]; do
        if ! src_auto_xorg_parse_installer_argument "$@"; then
          return 1
        fi

        shift
      done

      return 0
    }

  #
  # DESC:   Parse argument for installer.
  # $*:     the arguments as a string.
  # RETURN: If argument is empty or valid, return 0.
  #         If argument is not valid or there exists conflicting arguments, return 1.
  #
    function src_auto_xorg_parse_installer_argument
    {
      if ! is_string "${1}"; then
        return 0
      fi

      local -ar arr_arguments=$@

      if array_contains_value "arr_arguments" "--install" \
        && array_contains_value "arr_arguments" "--uninstall"; then
        print_conflicting_options
        return 1
      fi

      if ! src_auto_xorg_parse_argument "$@"; then
        return 1
      fi

      if is_string "${1}"; then
        print_invalid_argument "${1}"
        return 1
      fi

      return 0
    }

  #
  # DESC:   Print usage for this source. Copied from Auto X.Org.
  # RETURN: Always return 0.
  #
    function src_auto_xorg_print_usage
    {
      local -ar arr_output=(
        "\nAuto X.Org:"
        "\t--install\t\tInstall Auto X.Org."
        "\t--uninstall\t\t\tUninstall Auto X.Org."
        "\t--first\t\tFind the first valid VGA device."
        "\t--last\t\tFind the last valid VGA device."
        "\t--amd\t\tPrefer AMD or ATI."
        "\t--intel\t\tPrefer Intel."
        "\t--nvidia\t\tPrefer NVIDIA."
        "\t--other\t\tPrefer any other brand."
      )

      echo -e "${arr_output[*]}"
      return 0
    }

  # DESC:   Uninstall Auto X.Org.
  # RETURN: If uninstall is successful, return 0.
  #         If false, return 1.
  #
    function uninstall_auto_xorg
    {
      log_stdout "${0}: ${FUNCNAME}"

      print_output_to_log "Uninstalling Auto X.Org..."

      if ! execute_auto_xorg_installer "--uninstall"; then
        print_output_to_log "Failed."
        return 1
      fi

      print_output_to_log "Successful."
      return 0
    }